{"pages":[],"posts":[{"title":"[DASCTF2024å¤å­£æŒ‘æˆ˜èµ›]StrangePrograme","text":"çœ¼å‰æ‰€è§ï¼Œäº¦éçœŸå® ä½ çœ‹åˆ°çš„æˆ‘å¹¶ä¸æ˜¯çœŸæ­£çš„æˆ‘ï¼Œä½ çœ‹åˆ°çš„memcmpä¸æ˜¯çœŸæ­£çš„memcmp ä¸ºä»€ä¹ˆmemcmpè¦ä¿ç•™å®ƒå½“memcmpå‡½æ•°çš„å†å² å› ä¸ºå®ƒæ˜¯é’©å­ .DASCTFæ®µä¸€å¤§æ®µçˆ†çº¢ï¼Œé¦–å…ˆæƒ³åˆ°smc è·ŸéšIsDebuggerPresent()çš„è„šæ­¥æ¥åˆ°è¿™ä¸ªå‡½æ•° æ‰¾åˆ°smcçš„åœ°æ–¹ ä¸‹é¢æ˜¯è¢«åŠ å¯†çš„.DASCTFæ®µ æ–­ç‚¹ä¸€æ‰“ï¼Œå¼€å§‹è°ƒè¯• .DASCTFæ®µè§£å¯†åæ¢å¤é‡Œé¢çš„å‡ ä¸ªå…³é”®å‡½æ•° è¿™é‡Œï¼Œmemcmpè¢«hookäº†ï¼Œå®ƒå·²ç»ä¸æ˜¯åŸæ¥çš„memcmpäº† è¿™é‡Œæ˜¯åŠ å¯† TEA æ­¤æ—¶å¦‚æœå›ä¸»å‡½æ•°æ‰¾åˆ°memcmpï¼Œä¸€è·¯è·Ÿè¿›ï¼Œä¼šæ¥åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œè¿™æ˜¯åŠ¨æ€é“¾æ¥åº“é‡Œçš„memcmp æ€»å¾—æ¥è¯´ï¼Œè¢«hookçš„å‡½æ•°ä¼šæ”¹å˜å®ƒåŸæœ¬çš„åŠŸèƒ½ï¼Œæ‰€ä»¥mainå‡½æ•°é‡Œçš„memcmpå¹¶ä¸æ˜¯æ¯”è¾ƒï¼Œè€Œæ˜¯åŠ å¯† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130#include &lt;bits/stdc++.h&gt;using namespace std;void De_tea(unsigned int *a1, unsigned int *a2){ unsigned int i; // [esp+DCh] [ebp-2Ch] int v4; // [esp+E8h] [ebp-20h] unsigned int v5; // [esp+F4h] [ebp-14h] unsigned int v6; // [esp+100h] [ebp-8h] v6 = *a1; v5 = a1[1]; // for (i = 0; i &lt; 16; ++i) // { // v6 += (a2[1] + (v5 &gt;&gt; 5)) ^ (v4 + v5) ^ (*a2 + 16 * v5); // v5 += (a2[3] + (v6 &gt;&gt; 5)) ^ (v4 + v6) ^ (a2[2] + 16 * v6); // v4 -= 1640531527; // } v4 = 0 - 16 * 0x61C88647; for (i = 0; i &lt; 16; ++i) { v4 += 0x61C88647; v5 -= (a2[3] + (v6 &gt;&gt; 5)) ^ (v4 + v6) ^ (a2[2] + 16 * v6); v6 -= (a2[1] + (v5 &gt;&gt; 5)) ^ (v4 + v5) ^ (*a2 + 16 * v5); } *a1 = v6; a1[1] = v5;}int main(){ __int64 v1; // rax __int64 v3; // [esp-8h] [ebp-24Ch] int j; // [esp+D0h] [ebp-174h] size_t i; // [esp+F4h] [ebp-150h] char *v6; // [esp+100h] [ebp-144h] unsigned int v7; // [esp+124h] [ebp-120h] BYREF int v8; // [esp+128h] [ebp-11Ch] int v9; // [esp+12Ch] [ebp-118h] int v10; // [esp+130h] [ebp-114h] unsigned char v11[41]; // [esp+13Ch] [ebp-108h] BYREF int savedregs; // [esp+244h] [ebp+0h] BYREF v11[0] = 0xF9; v11[1] = 0x4D; v11[2] = 0x2B; v11[3] = 0xBC; v11[4] = 0x13; v11[5] = 0xDD; v11[6] = 0x13; v11[7] = 0x62; v11[8] = 0xC9; v11[9] = 0xFC; v11[10] = 0xFF; v11[11] = 0x89; v11[12] = 0x7D; v11[13] = 0x4F; v11[14] = 0xC9; v11[15] = 0xF; v11[16] = 0x63; v11[17] = 0x1D; v11[18] = 0x6D; v11[19] = 0x52; v11[20] = 0x50; v11[21] = 0xFD; v11[22] = 0x41; v11[23] = 0xE3; v11[24] = 0x33; v11[25] = 0x76; v11[26] = 0x28; v11[27] = 0x97; v11[28] = 0x38; v11[29] = 0x36; v11[30] = 0xF9; v11[31] = 0x6B; v11[32] = 0x90; v11[33] = 0x39; v11[34] = 0x14; v11[35] = 0x83; v11[36] = 0x2C; v11[37] = 0xE2; v11[38] = 0x2C; v11[39] = 0x1F; v11[40] = 0x0; // unsigned int enc[10] = { // 0xBC2B4DF9, 0x6213DD13, 0x89FFFCC9, 0x0FC94F7D, 0x526D1D63, 0xE341FD50, 0x97287633, 0x6BF93638, // 0x83143990, 0x1F2CE22C}; // unsigned int key[4] = { // 0x12345678, 0x09101112, 0x13141516, 0x15161718}; // v8 = *(v11 + 1); // *v6 = v8; unsigned char key[16] = { 0x78, 0x56, 0x34, 0x12, 0x12, 0x11, 0x10, 0x09, 0x16, 0x15, 0x14, 0x13, 0x18, 0x17, 0x16, 0x15}; unsigned int *p = (unsigned int *)v11; for (int i = 8; i &gt;= 2;i -= 2){ // *&amp;v11[4 * i + 4] ^= *v11; // *&amp;v11[4 * 1] ^= *v6; // *(unsigned int *)&amp;v11[4 * i + 4] ^= p[1]; // *(unsigned int *)&amp;v11[4 * i] ^= p[0]; *(unsigned int *)&amp;v11[4 * i + 4] ^= v11[1]; *(unsigned int *)&amp;v11[4 * i] ^= v11[0]; // enc[i] ^= enc[1]; // enc[i - 1] ^= enc[0]; De_tea(p, (unsigned int *)key); // De_tea((unsigned int *)v11, (unsigned int *)key); } De_tea(p, (unsigned int *)key); for(int i = 0; i &lt; 40;++ i) printf(&quot;%c&quot;, v11[i]); return 0;} æ¥ä¸‹æ¥è¡¨æ¼”çš„èŠ‚ç›®æ˜¯ç¥å¥‡çš„æŒ‡é’ˆ å½“æˆ‘å°†expä¸­é—´éƒ¨åˆ†å†™æˆè¿™æ ·æ—¶ 12*(unsigned int *)&amp;v11[4 * i + 4] ^= *(unsigned int *)v11[1];*(unsigned int *)&amp;v11[4 * i] ^= *(unsigned int *)v11[0]; å®ƒçš„è¾“å‡ºæ˜¯è¿™æ ·çš„ å½“æˆ‘å†™æˆè¿™æ ·æ—¶ 123unsigned int *p = (unsigned int *)v11;*(unsigned int *)&amp;v11[4 * i + 4] ^= p[1];*(unsigned int *)&amp;v11[4 * i] ^= p[0]; å®ƒçš„è¾“å‡ºæ˜¯è¿™æ ·çš„ å½“æˆ‘å†™æˆè¿™æ ·æ—¶ 12*(unsigned int *)&amp;v11[4 * i + 4] ^= v11[1];*(unsigned int *)&amp;v11[4 * i] ^= v11[0]; å®ƒçš„è¾“å‡ºæ˜¯è¿™æ ·çš„ æŒ‡é’ˆï¼Œå¾ˆç¥å¥‡å§","link":"/2024/07/25/DASCTF2024%E5%A4%8F%E5%AD%A3%E6%8C%91%E6%88%98%E8%B5%9B-StrangePrograme/"},{"title":"ä¸´æ±Ÿä»™","text":"é’å±±ä¾æ—§åœ¨ï¼Œå‡ åº¦å¤•é˜³çº¢ ä¸´æ±Ÿä»™ã€æ˜ã€‘æ¨æ…æ»šæ»šé•¿æ±Ÿä¸œé€æ°´ï¼ŒæµªèŠ±æ·˜å°½è‹±é›„ã€‚æ˜¯éæˆè´¥è½¬å¤´ç©ºã€‚é’å±±ä¾æ—§åœ¨ï¼Œå‡ åº¦å¤•é˜³çº¢ã€‚ç™½å‘æ¸”æ¨µæ±Ÿæ¸šä¸Šï¼Œæƒ¯çœ‹ç§‹æœˆæ˜¥é£ã€‚ä¸€å£¶æµŠé…’å–œç›¸é€¢ã€‚å¤ä»Šå¤šå°‘äº‹ï¼Œéƒ½ä»˜ç¬‘è°ˆä¸­ã€‚","link":"/2024/07/25/%E4%B8%B4%E6%B1%9F%E4%BB%99/"},{"title":"æŠ¥ä»»å®‰ä¹¦","text":"ç„¶æ­¤å¯ä¸ºæ™ºè€…é“ï¼Œéš¾ä¸ºä¿—äººè¨€ä¹Ÿ æŠ¥ä»»å®‰ä¹¦ï¼ˆèŠ‚é€‰ï¼‰ã€ä¸¤æ±‰ã€‘å¸é©¬è¿å¤è€…å¯Œè´µè€Œåæ‘©ç­ï¼Œä¸å¯èƒœè®°ï¼Œå”¯å€œå‚¥éå¸¸ä¹‹äººç§°ç„‰ã€‚ç›–æ–‡ç‹æ‹˜è€Œæ¼”ã€Šå‘¨æ˜“ã€‹ï¼›ä»²å°¼å„è€Œä½œã€Šæ˜¥ç§‹ã€‹ï¼›å±ˆåŸæ”¾é€ï¼Œä¹ƒèµ‹ã€Šç¦»éªšã€‹ï¼›å·¦ä¸˜å¤±æ˜ï¼Œå¥æœ‰ã€Šå›½è¯­ã€‹ï¼›å­™å­è†‘è„šï¼Œã€Šå…µæ³•ã€‹ä¿®åˆ—ï¼›ä¸éŸ¦è¿èœ€ï¼Œä¸–ä¼ ã€Šå•è§ˆã€‹ï¼›éŸ©éå›šç§¦ï¼Œã€Šè¯´éš¾ã€‹ã€Šå­¤æ„¤ã€‹ï¼›ã€Šè¯—ã€‹ä¸‰ç™¾ç¯‡ï¼Œå¤§åº•åœ£è´¤å‘æ„¤ä¹‹æ‰€ä¸ºä½œä¹Ÿã€‚æ­¤äººçš†æ„æœ‰æ‰€éƒç»“ï¼Œä¸å¾—é€šå…¶é“ï¼Œæ•…è¿°å¾€äº‹ã€æ€æ¥è€…ã€‚ä¹ƒå¦‚å·¦ä¸˜æ— ç›®ï¼Œå­™å­æ–­è¶³ï¼Œç»ˆä¸å¯ç”¨ï¼Œé€€è€Œè®ºä¹¦ç­–ï¼Œä»¥èˆ’å…¶æ„¤ï¼Œæ€å‚ç©ºæ–‡ä»¥è‡ªè§ã€‚ ä»†çªƒä¸é€Šï¼Œè¿‘è‡ªæ‰˜äºæ— èƒ½ä¹‹è¾ï¼Œç½‘ç½—å¤©ä¸‹æ”¾å¤±æ—§é—»ï¼Œç•¥è€ƒå…¶è¡Œäº‹ï¼Œç»¼å…¶ç»ˆå§‹ï¼Œç¨½å…¶æˆè´¥å…´åä¹‹çºªï¼Œä¸Šè®¡è½©è¾•ï¼Œä¸‹è‡³äºå…¹ï¼Œä¸ºåè¡¨ï¼Œæœ¬çºªåäºŒï¼Œä¹¦å…«ç« ï¼Œä¸–å®¶ä¸‰åï¼Œåˆ—ä¼ ä¸ƒåï¼Œå‡¡ç™¾ä¸‰åç¯‡ã€‚äº¦æ¬²ä»¥ç©¶å¤©äººä¹‹é™…ï¼Œé€šå¤ä»Šä¹‹å˜ï¼Œæˆä¸€å®¶ä¹‹è¨€ã€‚è‰åˆ›æœªå°±ï¼Œä¼šé­æ­¤ç¥¸ï¼Œæƒœå…¶ä¸æˆï¼Œæ˜¯ä»¥å°±æåˆ‘è€Œæ— æ„ è‰²ã€‚ä»†è¯šä»¥è‘—æ­¤ä¹¦ï¼Œè—ä¹‹åå±±ï¼Œä¼ ä¹‹å…¶äººï¼Œé€šé‚‘å¤§éƒ½ï¼Œåˆ™ä»†å¿å‰è¾±ä¹‹è´£ï¼Œè™½ä¸‡è¢«æˆ®ï¼Œå²‚æœ‰æ‚”å“‰ï¼ç„¶æ­¤å¯ä¸ºæ™ºè€…é“ï¼Œéš¾ä¸ºä¿—äººè¨€ä¹Ÿï¼","link":"/2024/07/26/%E6%8A%A5%E4%BB%BB%E5%AE%89%E4%B9%A6/"},{"title":"360åŠ å›ºä¿å…è´¹ç‰ˆåˆ†æ","text":"åˆ†æ360åŠ å›ºä¿å…è´¹ç‰ˆï¼Œå­¦ä¹ é€†å‘æŠ€æœ¯ï¼ˆæ­¤ç¯‡æœªå®Œç»“ï¼‰ ä½¿ç”¨360åŠ å›ºä¿å…è´¹ç‰ˆåŠ å›ºï¼Œæ³¨æ„åŠ å›ºæ—¶è¦æŠŠç­¾åæ ¡éªŒç»™å»é™¤ï¼Œå› ä¸ºåŠ å›ºä¹‹åçš„appæ˜¯æ²¡æœ‰ç­¾åçš„ï¼Œè‡ªå·±ç­¾åä¹‹åå¦‚æœæœ‰ç­¾åæ ¡éªŒï¼Œç¨‹åºå¯èƒ½ä¼šé—ªé€€ â€ Javaå±‚åˆ†æè¿™æ˜¯æˆ‘è‡ªå·±å†™çš„ä¸€ä¸ªappï¼Œå¯ä»¥çœ‹åˆ°æ²¡æœ‰åŠ å›ºæ—¶å¯ä»¥ç›´æ¥çœ‹åˆ°MainActivity åŠ å›ºä¹‹åMainActivityå­—æ ·æ²¡äº†ï¼Œå‡ºç°äº†StubAPPç±»å’Œtianyu.utilå­—æ ·ï¼Œå¯ä»¥çŸ¥é“è¿™å°±æ˜¯è¯¥åŠ å›ºçš„ç‰¹å¾ StubAppç±»é‡Œé¢ä½¿ç”¨aæ–¹æ³•ä¼ é€’äº†ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œè·Ÿè¿›aæ–¹æ³•ï¼Œæ³¨æ„aæœ‰å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œéœ€è¦æŸ¥çœ‹å…·æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°çš„é‡è½½æ–¹æ³• å‘ç°å°±æ˜¯å¯¹å­—ç¬¦ä¸²è¿›è¡Œä¸€ä¸ªè§£æ··æ·†ï¼Œæ–¹å¼ä¸ºå¼‚æˆ–16ï¼Œè¿™é‡Œå¯ä»¥ç”¨Cyberchefå…ˆè§£ä¸€ä¸‹çœ‹çœ‹ ä½¿ç”¨Frida hookçœ‹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆï¼Œç›´æ¥åœ¨jadxé‡Œé€‰æ‹©å¤åˆ¶ä¸ºfridaç‰‡æ®µ 12345678910111213141516171819function hook() { let a = Java.use(&quot;com.tianyu.util.a&quot;); a[&quot;a&quot;].overload('java.lang.String').implementation = function (str) { console.log(`a.a is called: str=${str}`); let result = this[&quot;a&quot;](str); console.log(`a.a result=${result}`); return result; };}function main() { Java.perform(function () { hook(); })} å¯ä»¥çœ‹åˆ°å°±æ˜¯åŠ è½½äº†ä¸€äº›Androidç³»ç»Ÿå†…éƒ¨ç±»æˆ–æ–¹æ³•å ç»§ç»­è§‚å¯ŸStubAppç±»ï¼Œçœ‹è§ä¸‹é¢ä¼šæ ¹æ®è®¾å¤‡çš„æ¶æ„æ¥åŠ è½½ä¸åŒçš„soæ–‡ä»¶ å†ä¸æ­£å¸¸æœªåŠ å›ºçš„apkå¯¹æ¯”ä¸€ä¸‹ï¼Œå‘ç°åŠ å›ºä¹‹åçš„apkå¤šäº†ä¸€ä¸ªassetsæ–‡ä»¶å¤¹ï¼Œé‡Œé¢å­˜ç€ä¸€äº›soæ–‡ä»¶ ä¸éš¾åˆ†æå‡ºï¼Œè¯¥åŠ å›ºæ˜¯åœ¨Nativeå±‚æ¥é‡Šæ”¾dexæ–‡ä»¶ â€ Nativeå±‚åˆ†æåˆ†æsoæ–‡ä»¶ï¼Œå‘ç°å¯¼å…¥å¯¼å‡ºè¡¨è¢«æŠ¹é™¤å¾—ä¸€å¹²äºŒå‡€ å¦‚æœæ²¡æœ‰å¯¼å…¥å¯¼å‡ºè¡¨çš„è¯ï¼Œelfæ–‡ä»¶åº”è¯¥æ˜¯ä½¿ç”¨äº†è‡ªå®šä¹‰çš„åŠ¨æ€é“¾æ¥å™¨æ¥è¿›è¡Œé“¾æ¥çš„ï¼Œæ‰€ä»¥ï¼Œåªè¦å†elfæ–‡ä»¶è¢«è£…è½½è¿›å†…å­˜ä¹‹åå°†å®ƒdumpä¸‹æ¥ï¼Œåº”è¯¥å°±èƒ½æ¢å¤ç¬¦å·è¡¨äº† åœ¨Linuxç³»ç»Ÿä¸­ï¼Œdlopenå‡½æ•°ç”¨äºåŠ¨æ€é“¾æ¥åº“åŠ è½½å‡½æ•°ï¼Œå®ƒå­˜åœ¨äºlibdl.soåº“ä¸­ 123456789101112131415161718192021// 1. åŠ è½½åº“void* libHandle = dlopen(&quot;/data/data/pkg/libnative.so&quot;, RTLD_NOW);if (!libHandle) { printf(&quot;Error: %s\\n&quot;, dlerror()); return;}// 2. è·å–å‡½æ•°æŒ‡é’ˆtypedef int (*NativeFunc)(int);NativeFunc func = (NativeFunc)dlsym(libHandle, &quot;native_add&quot;);if (!func) { printf(&quot;Error: %s\\n&quot;, dlerror()); dlclose(libHandle); return;}// 3. è°ƒç”¨å‡½æ•°int result = func(42);// 4. å¸è½½åº“dlclose(libHandle); åœ¨å®‰å“7.0ä¹‹åï¼Œåˆ™éœ€è¦hookçš„æ˜¯android_dlopen_extå‡½æ•° frida hookä¸€ä¸‹çœ‹çœ‹å®ƒåŠ è½½äº†å“ªäº›å‡½æ•° android_dlopen_ext() çš„æ ¼å¼ä¸ºandroid_dlopen_ext(&quot;/data/data/pkg/libsecret.so&quot;, RTLD_NOW, NULL);ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è·å–ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼æ¥å¾—åˆ°å®ƒé“¾æ¥äº†å“ªäº›soæ–‡ä»¶ 1234567891011121314151617181920212223function hook() { Interceptor.attach(Module.findExportByName(&quot;libdl.so&quot;, &quot;android_dlopen_ext&quot;), { onEnter: function (args) { // console.log('Entering ' + functionName); // Modify or log arguments if needed console.log(&quot;load -&gt; &quot;, args[0].readCString()); }, onLeave: function (retval) { // console.log('Leaving ' + functionName); // Modify or log return value if needed } });}function main() { Java.perform(function () { hook(); })}setImmediate(main); æ­£å¦‚æ‰€æ–™ï¼Œå®ƒé“¾æ¥äº†è¿™ä¸ªsoæ–‡ä»¶ æ¥ä¸‹æ¥åœ¨å®ƒå°†è¯¥soæ–‡ä»¶è£…è½½åˆ°å†…å­˜ä¹‹ådumpä¸‹æ¥ï¼Œå°±å¯ä»¥å¾—åˆ°å¸¦æœ‰å¯¼å…¥å¯¼å‡ºè¡¨çš„soæ–‡ä»¶äº† ï¼ˆdumpè„šæœ¬æ¥è‡ªSWDDï¼‰ 1234567891011121314151617function dump_so() { var soName = &quot;libjiagu_64.so&quot;; var libSo = Process.getModuleByName(soName); var save_path = &quot;/data/data/com.example.nativetest/&quot; + libSo.name + &quot;_Dump&quot;; console.log(&quot;[Base]-&gt;&quot;, libSo.base); console.log(&quot;[Size]-&gt;&quot;, ptr(libSo.size)); var handle = new File(save_path, &quot;wb&quot;); Memory.protect(ptr(libSo.base), libSo.size, 'rwx'); var Buffer = libSo.base.readByteArray(libSo.size); handle.write(Buffer); handle.flush(); handle.close(); console.log(&quot;[DumpPath-&gt;]&quot;, save_path);}setImmediate(dump_so); æ³¨æ„ï¼Œè¦åœ¨appè¿è¡Œä¹‹åå†æŠŠè„šæœ¬é™„åŠ ä¸Šå»ï¼Œå¦åˆ™å¦‚æœè¿˜æ²¡æ¥å¾—åŠé“¾æ¥å°±dumpçš„è¯ï¼Œfridaä¼šç›´æ¥æŠ¥é”™ æ‰€ä»¥è¿™é‡Œä½¿ç”¨å‘½ä»¤ 1frida -U 'NativeTest' -l dump_so.js æˆåŠŸdumpï¼Œå¹¶ä¸”å¾—åˆ°äº†æ–‡ä»¶çš„åŸºåœ°å€å’Œå¤§å° æˆåŠŸæ¢å¤ â€ å£³æ–‡ä»¶åˆ†æè¿™é‡Œæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹ åŠ å›ºå£³çš„å…¸å‹è¡Œä¸ºæ¨¡å¼åŠ å›ºå£³çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ ä¿æŠ¤åŸå§‹ä»£ç ï¼Œå…¶å¸¸è§æµç¨‹åŒ…æ‹¬ï¼š è§£å¯†èµ„æºï¼š åŸå§‹ APK/Dex/So æ–‡ä»¶è¢«åŠ å¯†ï¼Œéšè—åœ¨ assetsã€lib/ æˆ–è‡ªå®šä¹‰ç›®å½•ä¸­ã€‚ è¿è¡Œæ—¶ï¼Œå£³ä»£ç éœ€è¦å…ˆ è¯»å–è¿™äº›åŠ å¯†æ–‡ä»¶ï¼ˆé€šè¿‡ open + readï¼‰ã€‚ åŠ¨æ€åŠ è½½ï¼š è§£å¯†åçš„æ–‡ä»¶ï¼ˆå¦‚ Dexã€Soï¼‰ä¼šé€šè¿‡ dlopenã€mmap æˆ– DexClassLoader åŠ è½½åˆ°å†…å­˜ã€‚ å†…å­˜æ‰§è¡Œï¼š è§£å¯†åçš„ä»£ç åœ¨å†…å­˜ä¸­æ‰§è¡Œï¼Œé¿å…ç•™ä¸‹å®Œæ•´çš„ç£ç›˜æ–‡ä»¶ã€‚ å…³é”®ç‚¹ï¼šâœ åŠ å›ºå£³å¿…é¡»è¯»å–åŠ å¯†æ–‡ä»¶ â†’ å¿…ç„¶è°ƒç”¨ open å‡½æ•° â†’ Hook â€‹openâ€‹ å¯ä»¥æ•è·æ–‡ä»¶è®¿é—®è·¯å¾„ã€‚ æ€è·¯å°±æ˜¯ hook openå‡½æ•°æ¥çœ‹çœ‹å®ƒæœ‰æ²¡æœ‰è¯»å–ä»€ä¹ˆä¸œè¥¿ 1234567891011121314151617181920212223242526function hook() { var openPtr = Module.findExportByName(null, &quot;open&quot;); // var openAdrr = new NativePointer(openPtr); const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']); Interceptor.replace(openPtr, new NativeCallback(function (fileNamePtr, flag) { var fileName = fileNamePtr.readCString(); console.log(&quot;[open : ]&quot;, fileName); return open(fileNamePtr, flag); } , 'int', ['pointer', 'int']))}function main() { Java.perform(function () { hook(); })}// setTimeout(main, 1000);setImmediate(main); æ³¨æ„è¿™é‡Œä¸€å®šè¦newä¸€ä¸ªNativeCallback åœ¨ Frida ä¸­ï¼ŒNativeCallback çš„ä½œç”¨æ˜¯ åˆ›å»ºä¸€ä¸ªç¬¦åˆåŸç”Ÿä»£ç è°ƒç”¨çº¦å®šçš„ JavaScript å›è°ƒå‡½æ•°ï¼Œç”¨äºæ›¿æ¢æˆ–æ‹¦æˆªåŸç”Ÿå‡½æ•°ï¼ˆå¦‚ openï¼‰ åŸç”Ÿä»£ç ï¼ˆå¦‚ C çš„ open å‡½æ•°ï¼‰æœ‰ä¸¥æ ¼çš„ å‚æ•°ä¼ é€’è§„åˆ™ï¼ˆå¦‚å¯„å­˜å™¨/æ ˆä¼ å‚ã€ç±»å‹è½¬æ¢ï¼‰ï¼Œè€Œ JavaScript æ˜¯å¼±ç±»å‹è¯­è¨€ï¼Œæ— æ³•ç›´æ¥åŒ¹é… ä¸ç„¶çš„è¯ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™ fileNamePtr å¯èƒ½æœªè¢«æ­£ç¡®è¯†åˆ«ä¸º pointer ç±»å‹ å¯ä»¥çœ‹åˆ°æ‰“å¼€äº†å¦‚ä¸‹æ–‡ä»¶ å‘ç°ä¸ªå¾ˆå¯ç–‘çš„ç‚¹ï¼Œå®ƒé¢‘ç¹è®¿é—®äº† /proc/self/maps â€‹/proc/self/mapsâ€‹ çš„ä½œç”¨ åŠŸèƒ½ï¼šè¯¥æ–‡ä»¶å®æ—¶æ˜¾ç¤ºå½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„å¸ƒå±€ï¼ŒåŒ…æ‹¬ï¼š åŠ è½½çš„æ¨¡å—ï¼ˆ.so/.dexï¼‰åŸºåœ°å€å’Œå¤§å° å†…å­˜æƒé™ï¼ˆå¯è¯»/å¯å†™/å¯æ‰§è¡Œï¼‰ æ–‡ä»¶æ¥æºè·¯å¾„ å…¸å‹è®¿é—®åœºæ™¯ï¼š åŠ å›ºå£³ï¼šæ£€æµ‹å†…å­˜æ˜¯å¦è¢«ç¯¡æ”¹ï¼ˆåè°ƒè¯•ï¼‰ã€‚ åŠ¨æ€åŠ è½½åº“ï¼šå®šä½ç©ºé—²å†…å­˜åŒºåŸŸåŠ è½½æ–°ä»£ç ã€‚ å†…å­˜æ‰«æï¼šæŸ¥æ‰¾æ•æ„Ÿæ•°æ®æˆ–å‡½æ•°åœ°å€ã€‚ è¿™é‡Œåå¤è¯»å–mapsçŒœæµ‹æ˜¯ä¸ºäº†æ··æ·†è§†å¬ï¼Œå½“åŠ è½½dexæ—¶ï¼Œmapsä¸Šçš„å†…å­˜æ˜ å°„ä¼šå‘ç”Ÿå˜åŒ–ï¼Œç•™ä¸‹è®°å½•ï¼Œæ¯”å¦‚ /data/app/xxx/base.dexï¼Œè¿™æ—¶å€™å£³æ–‡ä»¶å°±é€šè¿‡åå¤è¯»å–mapsæ¥éšè—æ‰“å¼€dexçš„æ“ä½œï¼Œæ©ç›–çœŸæ­£çš„ Dex åŠ è½½æ—¶æœº æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªfakeMapsï¼Œå°†å£³æ–‡ä»¶å¯¹mapsçš„æ“ä½œé‡å®šå‘åˆ°æˆ‘ä»¬çš„fakeMapsä¸Šï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è§‚å¯Ÿå£³æ–‡ä»¶åŠ è½½dexçš„æ“ä½œäº†ï¼ŒåŒæ—¶ä¹Ÿèƒ½é¿å…å£³çš„åæ£€æµ‹æœºåˆ¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445function hook() { var openPtr = Module.findExportByName(null, &quot;open&quot;); // var openAdrr = new NativePointer(openPtr); const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']); var fakeMaps = &quot;/data/data/com.example.nativetest/maps&quot; Interceptor.replace(openPtr, new NativeCallback(function (fileNamePtr, flag) { var fileName = fileNamePtr.readCString(); console.log(&quot;[open : ]&quot;, fileName); var FD = open(fileNamePtr, flag); //è°ƒç”¨åŸå§‹openå‡½æ•°ï¼Œè®°å½•åŸå§‹openå‡½æ•°çš„æ–‡ä»¶æè¿°ç¬¦ if (fileName.indexOf(&quot;maps&quot;) &gt;= 0) { //å¦‚æœæ–‡ä»¶ååŒ…å«mapsï¼Œå°†å…¶é‡å®šå‘åˆ°fakeMapsä¸Š console.log(&quot;sucess find maps&quot;); var fakeMapsAddr = Memory.allocUtf8String(fakeMaps); return open(fakeMapsAddr, flag); // æ‰“å¼€ä¼ªé€ çš„mapsæ–‡ä»¶ï¼Œå¹¶è¿”å›å…¶æ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰ï¼Œè€ŒéçœŸå®çš„maps } if (fileName.indexOf(&quot;dex&quot; != -1)) { console.warn(&quot;open dex :&quot;, fileName); } return FD; //è¿”å›åŸå§‹FDä½¿appæ­£å¸¸è¿è¡Œ // return open(fileNamePtr, flag); }, 'int', ['pointer', 'int']))}function main() { Java.perform(function () { hook(); })}// setTimeout(main, 1000);setImmediate(main); å¯ä»¥å‘ç°ç¡®å®æ˜¯é€šè¿‡openå»æ‰“å¼€äº†dexæ–‡ä»¶ï¼Œè€Œä¸”é€šè¿‡åå¤è¯»å–äº†mapsæ¥éšè—æ“ä½œï¼ŒéªŒè¯äº†æˆ‘ä»¬ä¹‹å‰çš„çŒœæƒ³ ä½¿ç”¨æ¥æŸ¥çœ‹dexçš„å†…å­˜åœ°å€ 1console.warn('dex called from:\\n' + Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join('\\n') + '\\n'); 12345678910111213141516171819202122232425262728293031323334353637383940414243function hook() { var openPtr = Module.findExportByName(null, &quot;open&quot;); // var openAdrr = new NativePointer(openPtr); const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']); var fakeMaps = &quot;/data/data/com.example.nativetest/maps&quot;; Interceptor.replace(openPtr, new NativeCallback(function (fileNamePtr, flag) { var fileName = fileNamePtr.readCString(); console.log(&quot;[open : ]&quot;, fileName); var FD = open(fileNamePtr, flag); //è°ƒç”¨åŸå§‹openå‡½æ•°ï¼Œè®°å½•åŸå§‹openå‡½æ•°çš„æ–‡ä»¶æè¿°ç¬¦ if (fileName.indexOf(&quot;maps&quot;) &gt;= 0) { //å¦‚æœæ–‡ä»¶ååŒ…å«mapsï¼Œå°†å…¶é‡å®šå‘åˆ°fakeMapsä¸Š console.log(&quot;sucess find maps&quot;); var fakeMapsAddr = Memory.allocUtf8String(fakeMaps); return open(fakeMapsAddr, flag); // æ‰“å¼€ä¼ªé€ çš„mapsæ–‡ä»¶ï¼Œå¹¶è¿”å›å…¶æ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰ï¼Œè€ŒéçœŸå®çš„maps } if (fileName.indexOf(&quot;dex&quot;) != -1) { console.warn(&quot;open dex :&quot;, fileName); console.warn('dex called from:\\n' + Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join('\\n') + '\\n'); } return FD; //è¿”å›åŸå§‹FDä½¿appæ­£å¸¸è¿è¡Œ // return open(fileNamePtr, flag); }, 'int', ['pointer', 'int']))}function main() { Java.perform(function () { hook(); })}// setTimeout(main, 1000);+setImmediate(main); å¯ä»¥å‘ç°æ‰“å¼€dexçš„åœ°å€åŸºæœ¬ä¸€æ¨¡ä¸€æ ·ï¼Œåœ¨IDAä¸­æŸ¥çœ‹è¿™ä¸ªåœ°å€ å˜¶ï¼Œå•¥ä¹Ÿæ²¡æœ‰ï¼Œè¿™ä¸å¯¹å§ æŸ¥é˜…å¤šæ–¹èµ„æ–™ï¼Œå‘ç°æˆ‘æ¼äº†ä¸€æ­¥ï¼Œåœ¨å…ˆå‰dump soæ–‡ä»¶çš„æ—¶å€™ï¼Œsoæ–‡ä»¶å¯èƒ½ä¼šæœ‰æŸåï¼Œæ‰€ä»¥å…ˆéœ€è¦ä¿®å¤ä¸€ä¸‹soæ–‡ä»¶ ä½¿ç”¨soFixer soFixer 0x0x7fff56d99000æ˜¯ä¹‹å‰dump soæ–‡ä»¶çš„æ—¶å€™è¾“å‡ºçš„åŸºåœ°å€ 1.\\SoFixer-Windows-64.exe -s .\\libjiagu_64.so_Dump -o .\\libjiagu_64.so_Fix -m 0x7fff56d99000 -d ä½¿ç”¨sofixä¹‹åIDAå°†å…¶è¯†åˆ«æˆäº†ARMæ¶æ„ï¼Œä½†æ˜¯æˆ‘åŸæœ¬çš„æ–‡ä»¶æ˜¯x86_64æ¶æ„ï¼Œè¿™é‡Œè¦é‡æ–°é€‰æ‹©ä¸€ä¸‹ è¿™ä¸‹å°±æ²¡é—®é¢˜äº† ä½†æ˜¯è¿™æ®µæ•°æ®å…¨æ˜¯æœªå®šä¹‰çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±æ‰‹è¶³æ— æªäº† ä¸€é€šä¹±ç¿»ï¼Œå‘ç°äº†è¿™æ ·ä¸€ä¸ªå‡½æ•° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596char __fastcall __arm_a_2(char *a1, unsigned __int64 a2, char *a3, int *a4, unsigned int a5){ unsigned __int64 v5; // rax __int64 *v6; // rsi __int64 v7; // rbx __int64 *v8; // rdi __int64 v9; // rax _QWORD *v10; // rbx char v12[8]; // [rsp+90h] [rbp-168h] BYREF unsigned __int64 v13; // [rsp+98h] [rbp-160h] __int64 v14; // [rsp+A0h] [rbp-158h] __int64 v15[7]; // [rsp+B0h] [rbp-148h] BYREF _QWORD v16[2]; // [rsp+E8h] [rbp-110h] BYREF __int128 v17; // [rsp+F8h] [rbp-100h] __int128 v18[8]; // [rsp+108h] [rbp-F0h] BYREF __int128 v19; // [rsp+188h] [rbp-70h] __int128 v20; // [rsp+198h] [rbp-60h] __int128 v21[2]; // [rsp+1A8h] [rbp-50h] BYREF int *v22; // [rsp+1D0h] [rbp-28h] unsigned __int64 v23; // [rsp+1D8h] [rbp-20h] unsigned __int64 v24; // [rsp+1E8h] [rbp-10h] v24 = __readfsqword(0x28u); v23 = a5; v22 = a4; sub_2DA0(); v5 = __readfsqword(0x28u); if ( v5 != v24 ) { sub_2D40(qword_1C928, 0x190LL); v23 = a1; v22 = __readfsqword(0x28u); memset(v21, 0, sizeof(v21)); v20 = 0LL; v19 = 0LL; memset(v18, 0, sizeof(v18)); v17 = 0LL; sub_2D20(v18 + 4, &quot;*.so&quot;, 0x80LL, 0xBCLL, 5LL); v16[0] = &amp;qword_234D0; v16[1] = 0xAC3FDLL; LODWORD(v18[0]) = 1; *&amp;v20 = off_233B8; *(&amp;v19 + 1) = &amp;qword_CFD40; DWORD2(v21[1]) = 1; *(&amp;v20 + 1) = 0x400000002LL; LODWORD(v21[0]) = 5; *(v21 + 8) = 0LL; sub_7330(v15); v15[0] = qword_22CA8 + 16; v6 = &amp;qword_CF8D0; if ( sub_7770(v15, &amp;qword_CF8D0, 1062LL) ) { v6 = v15; v7 = sub_5C10(v16, v15); if ( *(&amp;v21[0] + 1) ) (sub_2EE0)(); } else { v7 = 0LL; } v8 = v15; sub_7580(v15); if ( __readfsqword(0x28u) == v22 ) { LOBYTE(v5) = v7; } else { sub_2D40(v15, v6); v14 = v7; v13 = __readfsqword(0x28u); if ( v15 ) { strcpy(v12, &quot;makekey&quot;); v6 = v12; v9 = sub_5D40(v15, v12); if ( v9 ) { v10 = v9; v8 = (v9 &amp; 0xFFFFFFFFFFFFF000LL); v6 = (&quot;pthread_create&quot; + 3); sub_2E50(v9 &amp; 0xFFFFFFFFFFFFF000LL, 4096LL, 3LL); *v10 = qword_22CC0; } } v5 = __readfsqword(0x28u); if ( v5 != v13 ) { sub_2D40(v8, v6); LOBYTE(v5) = 1; } } } return v5;} æŸ¥çœ‹sub_50E0 å‘ç°äº†ä¸€äº›ç”¨äºåŠ è½½åŠ¨æ€é“¾æ¥ç›¸å…³çš„å­—ç¬¦ä¸²ï¼Œç»“åˆä¹‹å‰åˆ›å»ºçº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™å°±çŒœæµ‹ï¼Œåº”è¯¥å·²ç»åœ¨åŠ è½½å¦å¤–çš„soäº† â€ å®‰å“ç³»ç»Ÿä¸­ï¼Œå®Œæˆlinkerä¹‹åï¼Œdlopenå»åŠ è½½è¿™ä¸ªsoï¼Œæˆ‘ä»¬ä¹‹å‰hookçš„æ˜¯android_dlopen_extï¼Œè¿™é‡Œå†å»hookä¸€ä¸‹dlopençœ‹çœ‹å®ƒåŠ è½½äº†å“ªäº›soæ–‡ä»¶ 1234567891011121314151617181920212223242526272829303132333435363738394041function hook() { Interceptor.attach(Module.findExportByName(&quot;libdl.so&quot;, &quot;android_dlopen_ext&quot;), { onEnter: function (args) { // console.log('Entering ' + functionName); // Modify or log arguments if needed console.log(&quot;load -&gt; &quot;, args[0].readCString()); }, onLeave: function (retval) { // console.log('Leaving ' + functionName); // Modify or log return value if needed } });}function hook2() { Interceptor.attach(Module.findExportByName(&quot;libdl.so&quot;, &quot;dlopen&quot;), { onEnter: function (args) { // console.log('Entering ' + functionName); // Modify or log arguments if needed console.warn(&quot;dlopen load -&gt; &quot;, args[0].readCString()); }, onLeave: function (retval) { // console.log('Leaving ' + functionName); // Modify or log return value if needed } });}function main() { Java.perform(function () { hook(); hook2(); })}// setTimeout(main, 1000);setImmediate(main); çœ‹åˆ°è¿™é‡Œï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è¯´æ˜å°±æ˜¯è‡ªå®šä¹‰linkeråŠ å›ºsoæ–‡ä»¶äº† â€ æŸ¥é˜…èµ„æ–™å‘ç°ï¼Œè‡ªå®šä¹‰linkeråŠ å›ºsoçš„æµç¨‹æ˜¯ï¼Œè‡ªå®šä¹‰æ–‡ä»¶æ ¼å¼åŠ å¯†soï¼Œç„¶åå£³ä»£ç å®ç°å°†åŠ å¯†çš„soæ–‡ä»¶åŠ è½½ï¼Œé“¾æ¥é‡å®šä½å¹¶ä¿®æ­£soinfoï¼ˆä¸‰éƒ¨æ›²ï¼‰ ç®€å•æ¥è¯´å°±æ˜¯å°†elfæ–‡ä»¶çš„.textç­‰æ•°æ®æ®µè¿›è¡ŒåŠ å¯†ï¼Œç„¶ååœ¨linkçš„æ—¶å€™è¡¥å……soinfo soinfo æ˜¯ Android linker å†…éƒ¨ç»´æŠ¤çš„æ•°æ®ç»“æ„ï¼Œç”¨äº ç®¡ç†å·²åŠ è½½çš„å…±äº«åº“ï¼ˆ.soï¼‰ ã€‚æ¯ä¸ªè¢« dlopen æˆ–ç¨‹åºä¾èµ–çš„ .so éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ soinfo ç»“æ„ï¼Œå­˜å‚¨ï¼š åº“çš„åŸºåœ°å€ï¼ˆåŠ è½½åœ°å€ï¼‰ ç¬¦å·è¡¨ã€é‡å®šä½è¡¨ã€ä¾èµ–å…³ç³» åŠ¨æ€æ®µï¼ˆâ€‹ â€‹.dynamicâ€‹â€‹ ï¼‰è§£æåçš„ä¿¡æ¯ å‘½åç©ºé—´ï¼ˆç”¨äºåº“éš”ç¦»ï¼‰ â€‹soinfoâ€‹ çš„ç”Ÿå‘½å‘¨æœŸ åŠ è½½é˜¶æ®µï¼šdlopen â†’ linker è§£æ ELF â†’ åˆ›å»º soinfo å¹¶å¡«å……ä¿¡æ¯ã€‚ é“¾æ¥é˜¶æ®µï¼šlinker æ ¹æ® .dynamic æ®µè§£æä¾èµ–ã€ç¬¦å·ã€é‡å®šä½ã€‚ è¿è¡Œæ—¶ï¼šdlsym é€šè¿‡ soinfo æŸ¥æ‰¾ç¬¦å·åœ°å€ã€‚ å¸è½½é˜¶æ®µï¼šdlclose é‡Šæ”¾ soinfoã€‚ ç”±äºä¹‹å‰çš„soåœ¨æ‰§è¡Œçš„æ—¶å€™linkäº†å¦å¤–çš„soï¼Œæ‰€ä»¥å°†å…¶æ”¾å…¥010editoré‡ŒæŸ¥æ‰¾elfå¤´ æ‰¾åˆ°äº†elfå¤´ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°program headerå·²ç»è¢«åŠ å¯†äº† å†™ä¸€ä¸ªè„šæœ¬ï¼Œå°†0xd0000ä¹‹åçš„å†…å®¹æå–å‡ºæ¥ æå–å‡ºæ¥çš„soæ–‡ä»¶idaæ˜¯æ‰“ä¸å¼€çš„ï¼Œå› ä¸ºprogram headerå·²ç»è¢«åŠ å¯†äº† æ­¤æ—¶å°±éœ€è¦æ‰¾åˆ°è¿™ä¸ªsoæ˜¯åœ¨å“ªé‡Œè¢«è§£å¯†çš„ ç”¨oaciaå¤§ä½¬çš„é¡¹ç›®æ¥åˆ†æä¸€ä¸‹ç¨‹åºæ‰§è¡Œæµ https://github.com/oacia/stalker_trace_so 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960[Android Emulator 5554::com.example.nativetest ]-&gt; start Stalker!Stalker end!call1:JNI_OnLoadcall2:sub_C840call3:ffi_callcall4:sub_C450call5:sub_7330call6:sub_7770call7:sub_7370call8:_ZN9__arm_c_19__arm_c_0Evcall9:sub_77B0call10:sub_71F0call11:sub_C560call12:sub_7240call13:sub_42C0call14:sub_6310call15:sub_6A30call16:sub_6760call17:sub_4B40call18:sub_4F70call19:sub_50E0call20:sub_3B20call21:sub_7000call22:sub_6350call23:sub_7580call24:sub_10E1D0call25:sub_1BC3C0call26:sub_10B270call27:sub_1465C0call28:sub_14AC90call29:sub_10A5C0call30:sub_1BDD20call31:sub_14B3E0call32:sub_14D100call33:sub_1BDD50call34:sub_1A9BD0call35:sub_1459B0call36:sub_1BD700call37:sub_1BD790call38:sub_10ED90call39:sub_1120F0call40:sub_10CC10call41:sub_106F90call42:sub_1BB530call43:sub_1BB620call44:sub_1BC4E0call45:sub_1BB980call46:sub_1BBC00call47:sub_1BBE10call48:sub_1BC1D0call49:sub_1BC4B0call55:sub_1BDF10call56:sub_116720call57:sub_1BDD00call58:sub_1AD9E0call59:sub_1ADB60call60:sub_1C49A0call61:sub_1CAD30call62:sub_1C8EC0call63:sub_16FA70 å†çœ‹ä¸€ä¸‹fixä¹‹åçš„æ–‡ä»¶çš„æ§åˆ¶æµ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364[Android Emulator 5554::com.example.nativetest ]-&gt; start Stalker!call1:JNI_OnLoadcall2:sub_C840call3:ffi_callcall4:sub_C450call5:sub_7330call6:sub_7770call7:sub_7370call8:_ZN9__arm_c_19__arm_c_0Evcall9:sub_77B0call10:sub_71F0call11:sub_C560call12:sub_7240call13:sub_42C0call14:sub_6310call15:sub_6A30call16:sub_6760call17:sub_4B40call18:sub_4F70call19:sub_50E0call20:sub_3B20call21:sub_7000call22:sub_6350call23:sub_7580call24:sub_10E1D0call25:sub_1BC3C0call26:sub_10B270call27:sub_1465C0call28:sub_14AC90call29:sub_10A5C0call30:sub_1BDD20call31:sub_14B3E0call32:sub_14D100call33:sub_1BDD50call34:sub_1A9BD0call35:sub_1459B0call36:sub_1BD700call37:sub_1BD790call38:sub_10ED90call39:sub_1120F0call40:sub_10CC10call41:sub_106F90call42:sub_1BB530call43:sub_1BB620call44:sub_1BC4E0call45:sub_1BB980call46:sub_1BBC00call47:sub_1BBE10call48:sub_1BC1D0call49:sub_1BC4B0call50:sub_14B000call51:sub_14D310call52:_Z9__arm_a_2PcmS_Riicall53:sub_14ACC0call54:sub_10C5F0call55:sub_1BDF10call56:sub_116720call57:sub_1BDD00call58:sub_1AD9E0call59:sub_1ADB60call60:sub_1C49A0call61:sub_1CAD30call62:sub_1C8EC0call63:sub_16FA70 â€ â€ çŸ¥é“äº†æ§åˆ¶æµä¹‹åï¼Œè™½ç„¶æ˜¯è‡ªå®šä¹‰linkeråŠ å›ºsoï¼Œä½†æ˜¯æœ€åè‚¯å®šè¿˜æ˜¯éœ€è¦dlopenå»åŠ è½½soçš„ï¼Œåœ¨IDAé‡Œäº¤å‰å¼•ç”¨ä¸€ä¸‹dlopenï¼Œçœ‹çœ‹åœ¨å“ªé‡Œè¢«è°ƒç”¨äº† åªæœ‰ä¸€å¤„è°ƒç”¨ï¼Œå…¨æ˜¯switch caseç»“æ„ æŸ¥çœ‹Androidæºç linkerçš„é¢„é“¾æ¥éƒ¨åˆ†ï¼ŒåŒæ ·ä¹Ÿæ˜¯å¤§é‡çš„switch caseç»“æ„ æ­¤æ—¶å°±å¯ä»¥åœ¨IDAä¸­å¯¼å…¥soinfoç»“æ„ä½“äº†ï¼ˆç»“æ„ä½“ä»£ç æ¥è‡ªSWDDï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296//IMPORTANT//ELF64 å¯ç”¨è¯¥å®#define __LP64__ 1//ELF32 å¯ç”¨è¯¥å®//#define __work_around_b_24465209__ 1 /*//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bpæ¶æ„ä¸º 32 ä½ å®šä¹‰__work_around_b_24465209__å®arch: { arm: {cflags: [&quot;-D__work_around_b_24465209__&quot;],}, x86: {cflags: [&quot;-D__work_around_b_24465209__&quot;],}, }*/ //android-platform\\bionic\\libc\\include\\link.h#if defined(__LP64__)#define ElfW(type) Elf64_ ## type#else#define ElfW(type) Elf32_ ## type#endif //android-platform\\bionic\\linker\\linker_common_types.h// Android uses RELA for LP64.#if defined(__LP64__)#define USE_RELA 1#endif //android-platform\\bionic\\libc\\kernel\\uapi\\asm-generic\\int-ll64.h//__signed__--&gt;signedtypedef signed char __s8;typedef unsigned char __u8;typedef signed short __s16;typedef unsigned short __u16;typedef signed int __s32;typedef unsigned int __u32;typedef signed long long __s64;typedef unsigned long long __u64; //A12-src\\msm-google\\include\\uapi\\linux\\elf.h/* 32-bit ELF base types. */typedef __u32 Elf32_Addr;typedef __u16 Elf32_Half;typedef __u32 Elf32_Off;typedef __s32 Elf32_Sword;typedef __u32 Elf32_Word; /* 64-bit ELF base types. */typedef __u64 Elf64_Addr;typedef __u16 Elf64_Half;typedef __s16 Elf64_SHalf;typedef __u64 Elf64_Off;typedef __s32 Elf64_Sword;typedef __u32 Elf64_Word;typedef __u64 Elf64_Xword;typedef __s64 Elf64_Sxword; typedef struct dynamic{ Elf32_Sword d_tag; union{ Elf32_Sword d_val; Elf32_Addr d_ptr; } d_un;} Elf32_Dyn; typedef struct { Elf64_Sxword d_tag; /* entry tag value */ union { Elf64_Xword d_val; Elf64_Addr d_ptr; } d_un;} Elf64_Dyn; typedef struct elf32_rel { Elf32_Addr r_offset; Elf32_Word r_info;} Elf32_Rel; typedef struct elf64_rel { Elf64_Addr r_offset; /* Location at which to apply the action */ Elf64_Xword r_info; /* index and type of relocation */} Elf64_Rel; typedef struct elf32_rela{ Elf32_Addr r_offset; Elf32_Word r_info; Elf32_Sword r_addend;} Elf32_Rela; typedef struct elf64_rela { Elf64_Addr r_offset; /* Location at which to apply the action */ Elf64_Xword r_info; /* index and type of relocation */ Elf64_Sxword r_addend; /* Constant addend used to compute value */} Elf64_Rela; typedef struct elf32_sym{ Elf32_Word st_name; Elf32_Addr st_value; Elf32_Word st_size; unsigned char st_info; unsigned char st_other; Elf32_Half st_shndx;} Elf32_Sym; typedef struct elf64_sym { Elf64_Word st_name; /* Symbol name, index in string tbl */ unsigned char st_info; /* Type and binding attributes */ unsigned char st_other; /* No defined meaning, 0 */ Elf64_Half st_shndx; /* Associated section index */ Elf64_Addr st_value; /* Value of the symbol */ Elf64_Xword st_size; /* Associated symbol size */} Elf64_Sym; #define EI_NIDENT 16 typedef struct elf32_hdr{ unsigned char e_ident[EI_NIDENT]; Elf32_Half e_type; Elf32_Half e_machine; Elf32_Word e_version; Elf32_Addr e_entry; /* Entry point */ Elf32_Off e_phoff; Elf32_Off e_shoff; Elf32_Word e_flags; Elf32_Half e_ehsize; Elf32_Half e_phentsize; Elf32_Half e_phnum; Elf32_Half e_shentsize; Elf32_Half e_shnum; Elf32_Half e_shstrndx;} Elf32_Ehdr; typedef struct elf64_hdr { unsigned char e_ident[EI_NIDENT]; /* ELF &quot;magic number&quot; */ Elf64_Half e_type; Elf64_Half e_machine; Elf64_Word e_version; Elf64_Addr e_entry; /* Entry point virtual address */ Elf64_Off e_phoff; /* Program header table file offset */ Elf64_Off e_shoff; /* Section header table file offset */ Elf64_Word e_flags; Elf64_Half e_ehsize; Elf64_Half e_phentsize; Elf64_Half e_phnum; Elf64_Half e_shentsize; Elf64_Half e_shnum; Elf64_Half e_shstrndx;} Elf64_Ehdr; /* These constants define the permissions on sections in the program header, p_flags. */#define PF_R 0x4#define PF_W 0x2#define PF_X 0x1 typedef struct elf32_phdr{ Elf32_Word p_type; Elf32_Off p_offset; Elf32_Addr p_vaddr; Elf32_Addr p_paddr; Elf32_Word p_filesz; Elf32_Word p_memsz; Elf32_Word p_flags; Elf32_Word p_align;} Elf32_Phdr; typedef struct elf64_phdr { Elf64_Word p_type; Elf64_Word p_flags; Elf64_Off p_offset; /* Segment file offset */ Elf64_Addr p_vaddr; /* Segment virtual address */ Elf64_Addr p_paddr; /* Segment physical address */ Elf64_Xword p_filesz; /* Segment size in file */ Elf64_Xword p_memsz; /* Segment size in memory */ Elf64_Xword p_align; /* Segment alignment, file &amp; memory */} Elf64_Phdr; typedef struct elf32_shdr { Elf32_Word sh_name; Elf32_Word sh_type; Elf32_Word sh_flags; Elf32_Addr sh_addr; Elf32_Off sh_offset; Elf32_Word sh_size; Elf32_Word sh_link; Elf32_Word sh_info; Elf32_Word sh_addralign; Elf32_Word sh_entsize;} Elf32_Shdr; typedef struct elf64_shdr { Elf64_Word sh_name; /* Section name, index in string tbl */ Elf64_Word sh_type; /* Type of section */ Elf64_Xword sh_flags; /* Miscellaneous section attributes */ Elf64_Addr sh_addr; /* Section virtual addr at execution */ Elf64_Off sh_offset; /* Section file offset */ Elf64_Xword sh_size; /* Size of section in bytes */ Elf64_Word sh_link; /* Index of another section */ Elf64_Word sh_info; /* Additional section information */ Elf64_Xword sh_addralign; /* Section alignment */ Elf64_Xword sh_entsize; /* Entry size if section holds table */} Elf64_Shdr; //android-platform\\bionic\\linker\\linker_soinfo.htypedef void (*linker_dtor_function_t)();typedef void (*linker_ctor_function_t)(int, char**, char**); #if defined(__work_around_b_24465209__)#define SOINFO_NAME_LEN 128#endif struct soinfo {#if defined(__work_around_b_24465209__) char old_name_[SOINFO_NAME_LEN];#endif const ElfW(Phdr)* phdr; size_t phnum;#if defined(__work_around_b_24465209__) ElfW(Addr) unused0; // DO NOT USE, maintained for compatibility.#endif ElfW(Addr) base; size_t size; #if defined(__work_around_b_24465209__) uint32_t unused1; // DO NOT USE, maintained for compatibility.#endif ElfW(Dyn)* dynamic; #if defined(__work_around_b_24465209__) uint32_t unused2; // DO NOT USE, maintained for compatibility uint32_t unused3; // DO NOT USE, maintained for compatibility#endif soinfo* next; uint32_t flags_; const char* strtab_; ElfW(Sym)* symtab_; size_t nbucket_; size_t nchain_; uint32_t* bucket_; uint32_t* chain_; #if !defined(__LP64__) ElfW(Addr)** unused4; // DO NOT USE, maintained for compatibility#endif #if defined(USE_RELA) ElfW(Rela)* plt_rela_; size_t plt_rela_count_; ElfW(Rela)* rela_; size_t rela_count_;#else ElfW(Rel)* plt_rel_; size_t plt_rel_count_; ElfW(Rel)* rel_; size_t rel_count_;#endif linker_ctor_function_t* preinit_array_; size_t preinit_array_count_; linker_ctor_function_t* init_array_; size_t init_array_count_; linker_dtor_function_t* fini_array_; size_t fini_array_count_; linker_ctor_function_t init_func_; linker_dtor_function_t fini_func_; /*#if defined (__arm__) // ARM EABI section used for stack unwinding. uint32_t* ARM_exidx; size_t ARM_exidx_count;#endif size_t ref_count_;// æ€ä¹ˆæ‰¾ä¸ link_map è¿™ä¸ªç±»å‹çš„å£°æ˜... link_map link_map_head; bool constructors_called; // When you read a virtual address from the ELF file, add this //value to get the corresponding address in the process' address space. ElfW (Addr) load_bias; #if !defined (__LP64__) bool has_text_relocations;#endif bool has_DT_SYMBOLIC;*/}; æŒ‰Yå°†è¯¥å‡½æ•°ç±»å‹æ”¹æˆso å¥½çœ‹å¤šäº†ï¼Œä½†çœ‹ç€è¿˜æ˜¯æœ‰ç‚¹å¥‡æ€ªï¼Œå¯èƒ½è¿™ä¸ªsoinfoè¢«é­”æ”¹è¿‡äº† äº¤å‰å¼•ç”¨ä¸€ä¸‹ï¼Œæ¥åˆ°ä¸Šä¸€ä¸ªå‡½æ•°ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ æœ€ç»ˆæ¥åˆ°è¿™ä¸ªåœ°æ–¹ æœ‰ä¸€ä¸ªå¾ˆå¯ç–‘çš„ç‚¹æ˜¯v5å¾€ä¸ŠåŠ äº†0x38 åœ¨ELFæ–‡ä»¶ä¸­ï¼Œ32 ä½ ELF æ–‡ä»¶ç¨‹åºå¤´å¤§å°æ˜¯ 0x20ï¼ˆ32 å­—èŠ‚ï¼‰ï¼Œ64 ä½ ELF æ–‡ä»¶ç¨‹åºå¤´å¤§å°æ˜¯ 0x38ï¼ˆ56 å­—èŠ‚ï¼‰ è¿™é‡Œæ­£å¥½å°±æ˜¯0x38ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½å°±åœ¨åŠ è½½ç¨‹åºå¤´äº†ã€‚ æ—¢ç„¶è¦åŠ è½½ç¨‹åºå¤´ï¼Œé‚£ä¹ˆåœ¨åŠ è½½ä¹‹å‰è‚¯å®šéœ€è¦è§£å¯†ï¼Œå¾€ä¸Šå¼•ç”¨ä¸€ä¸‹ï¼Œæœ€ååˆæ¥åˆ°è¿™é‡Œï¼Œæœ‰ç‚¹çœ¼ç†Ÿ è¿˜è®°å¾—ä¹‹å‰æ‹¿åˆ°çš„æ‰§è¡Œæµä¹ˆï¼Œä»7000ï¼Œå³åŠ è½½ç¨‹åºå¤´çš„å‡½æ•°å¼€å§‹ï¼Œå¾€ä¸Šæ‰¾ä¸€æ‰¾ åœ¨50E0çš„ä½ç½®å‘ç°è¿™é‡ŒåŠ è½½äº†ä¸€äº›ä¸œè¥¿ ç»§ç»­å¾€ä¸Šç¿»ï¼Œåœ¨7240çš„ä½ç½®å¡«å…¥äº†ä¸€ä¸ªåœ°å€è¿›å» å»é‚£ä¸ªåœ°å€çœ‹ä¸€çœ¼ï¼ŒAUVï¼Œè¿™ä¸rc4ä¹ˆ ä¸Šé¢é‚£ä¸ªåˆ™æ˜¯åˆå§‹åŒ–ç®—æ³• ç›´æ¥hookå‡ºsbox â€","link":"/2025/07/25/360%E5%8A%A0%E5%9B%BA%E4%BF%9D%E5%85%8D%E8%B4%B9%E7%89%88/"},{"title":"å®‰å“Nativeå±‚å‡½æ•°æ³¨å†Œ","text":"å½“æ‰§è¡Œä¸€ä¸ª Java çš„ native æ–¹æ³•æ—¶ï¼Œè™šæ‹Ÿæœºæ˜¯æ€ä¹ˆçŸ¥é“è¯¥è°ƒç”¨ so ä¸­çš„å“ªä¸ªæ–¹æ³•å‘¢ï¼Ÿè¿™å°±éœ€è¦ç”¨åˆ°æ³¨å†Œçš„æ¦‚å¿µäº†ï¼Œé€šè¿‡æ³¨å†Œï¼Œå°†æŒ‡å®šçš„ native æ–¹æ³•å’Œ so ä¸­å¯¹åº”çš„æ–¹æ³•ç»‘å®šèµ·æ¥ï¼ˆå‡½æ•°æ˜ å°„è¡¨ï¼‰ï¼Œè¿™æ ·å°±èƒ½å¤Ÿæ‰¾åˆ°ç›¸åº”çš„æ–¹æ³•äº†ã€‚æ³¨å†Œåˆ†ä¸º é™æ€æ³¨å†Œ å’Œ åŠ¨æ€æ³¨å†Œä¸¤ç§ã€‚é»˜è®¤çš„å®ç°æ–¹å¼å³é™æ€æ³¨å†Œ é™æ€æ³¨å†ŒJava æ–¹æ³•ä¸ C å‡½æ•°é€šè¿‡åå­—è§„åˆ™è‡ªåŠ¨å¯¹åº”ï¼ŒC/C++ çš„å‡½æ•°åå¿…é¡»ä¸¥æ ¼éµå¾ªå‘½åè§„èŒƒï¼š 1Java_åŒ…å_ç±»å_æ–¹æ³•å(JNIEnv* env, jobject obj, ...) ä¾‹å­12345678package com.example;public class MyClass { public native void sayHello(); static { System.loadLibrary(&quot;native-lib&quot;); }} nativeä»£ç  1234567#include &lt;jni.h&gt;#include &lt;stdio.h&gt;JNIEXPORT void JNICALLJava_com_example_MyClass_sayHello(JNIEnv* env, jobject obj) { printf(&quot;Hello from C!\\n&quot;);} é€†å‘åœ¨Javaå±‚å¯ä»¥çœ‹åˆ°Nativeå±‚æ³¨å†Œçš„å‡½æ•° åœ¨Nativeå±‚ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ³¨å†Œçš„å‡½æ•°ï¼Œéµå¾ªé™æ€æ³¨å†Œçš„å‘½åè§„åˆ™ â€ åŠ¨æ€æ³¨å†Œåœ¨æœ¬åœ°åº“åŠ è½½æ—¶ï¼ˆé€šå¸¸åœ¨ JNI_OnLoad()ï¼‰ï¼Œæˆ–è€…åœ¨è¿è¡Œæ—¶ç”± C/C++ ä»£ç ä¸»åŠ¨è°ƒç”¨ RegisterNatives()ï¼ŒæŠŠä¸€ç»„ Java æ–¹æ³•å + æ–¹æ³•ç­¾å + æœ¬åœ°å‡½æ•°æŒ‡é’ˆ æ˜ å°„æ³¨å†Œåˆ° JVMï¼Œä»è€Œè®© Java ä»£ç è°ƒç”¨è¿™äº›æœ¬åœ°å®ç°ã€‚å®ƒä¸ä¾èµ–å‡½æ•°åçš„å›ºå®šå‘½åè§„åˆ™ï¼ˆJava_package_Class_methodï¼‰æ‰‹åŠ¨æŠŠJavaæ–¹æ³•å’ŒCå‡½æ•°çš„å¯¹åº”å…³ç³»æ³¨å†Œåˆ°JVM â€‹JNI_OnLoad(JavaVM* vm, void* reserved) åœ¨ native-lib è¢« System.loadLibrary() æ—¶è°ƒç”¨ ä¾‹å­12345678910111213package com.example;public class MyClass { static { System.loadLibrary(&quot;native-lib&quot;); } // Java å£°æ˜ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰ public native void sayHello(); public native int add(int a, int b); public static native String staticEcho(String s);} 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596// file: native_reg.c#include &lt;jni.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;// å¦‚æœæ˜¯ C++ ç¼–è¯‘å™¨ï¼Œé˜²æ­¢å‡½æ•°åè¢« mangling#ifdef __cplusplusextern &quot;C&quot; {#endif// -------------------- æœ¬åœ°å®ç°å‡½æ•° --------------------// å®ä¾‹æ–¹æ³•ï¼ˆå¯¹åº” Java çš„é static native æ–¹æ³•ï¼‰static void native_sayHello(JNIEnv* env, jobject thiz) { // ç®€å•æ‰“å° â€”â€” æ³¨æ„ï¼šAndroid ä¸Šç”¨ printf å¯èƒ½çœ‹ä¸åˆ°ï¼Œå»ºè®®ç”¨ __android_log_print printf(&quot;native_sayHello invoked\\n&quot;);}// å®ä¾‹æ–¹æ³•ï¼šå¸¦è¿”å›å€¼ä¸å‚æ•°static jint native_add(JNIEnv* env, jobject thiz, jint a, jint b) { return a + b;}// é™æ€æ–¹æ³•ï¼ˆå¯¹åº” Java çš„ static native æ–¹æ³•ï¼‰æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ç±»å‹æ˜¯ jclassstatic jstring native_staticEcho(JNIEnv* env, jclass clazz, jstring js) { const char* s = (*env)-&gt;GetStringUTFChars(env, js, NULL); if (s == NULL) { // OOM or other error return NULL; } // è¿™é‡Œå¯ä»¥å¤„ç†å­—ç¬¦ä¸²ï¼Œæ¼”ç¤ºç›´æ¥è¿”å›ä¸€ä¸ªæ–°å­—ç¬¦ä¸² jstring ret = (*env)-&gt;NewStringUTF(env, s); (*env)-&gt;ReleaseStringUTFChars(env, js, s); return ret;}// -------------------- æ–¹æ³•è¡¨ï¼šJava åç§°ã€ç­¾åã€C å‡½æ•°æŒ‡é’ˆ --------------------static JNINativeMethod methods[] = { // { &quot;Java æ–¹æ³•å&quot;, &quot;JNI ç­¾å&quot;, (void*)æœ¬åœ°å‡½æ•°æŒ‡é’ˆ } {&quot;sayHello&quot;, &quot;()V&quot;, (void*)native_sayHello}, {&quot;add&quot;, &quot;(II)I&quot;, (void*)native_add}, {&quot;staticEcho&quot;, &quot;(Ljava/lang/String;)Ljava/lang/String;&quot;, (void*)native_staticEcho}};// è¾…åŠ©ï¼šè®¡ç®—æ–¹æ³•è¡¨å¤§å°static const int methods_count = sizeof(methods) / sizeof(methods[0]);// -------------------- æ³¨å†Œå‡½æ•°ï¼ˆå°è£… RegisterNativesï¼‰ --------------------static int register_native_methods(JNIEnv* env) { // æ³¨æ„ï¼šè¿™é‡Œçš„ç±»è·¯å¾„ä½¿ç”¨æ–œæ ï¼Œä¸ä½¿ç”¨ç‚¹å· const char* kClassPathName = &quot;com/example/MyClass&quot;; jclass clazz = (*env)-&gt;FindClass(env, kClassPathName); if (clazz == NULL) { // å¦‚æœ FindClass å¤±è´¥ï¼Œæ‰“å°å¹¶æ¸…ç†å¼‚å¸¸ï¼ˆå¦‚æœæœ‰ï¼‰ if ((*env)-&gt;ExceptionCheck(env)) { (*env)-&gt;ExceptionDescribe(env); (*env)-&gt;ExceptionClear(env); } return JNI_FALSE; } // RegisterNatives è¿”å› &lt; 0 è¡¨ç¤ºå¤±è´¥ if ((*env)-&gt;RegisterNatives(env, clazz, methods, methods_count) &lt; 0) { if ((*env)-&gt;ExceptionCheck(env)) { (*env)-&gt;ExceptionDescribe(env); (*env)-&gt;ExceptionClear(env); } return JNI_FALSE; } // å¦‚æœä½ éœ€è¦é•¿æœŸå¼•ç”¨è¿™ä¸ª jclassï¼Œåº”è¯¥åˆ›å»ºå…¨å±€å¼•ç”¨ï¼š // jclass globalClazz = (*env)-&gt;NewGlobalRef(env, clazz); // ç„¶åå­˜å‚¨ globalClazz ä¾›ä»¥åä½¿ç”¨ï¼Œå¹¶åœ¨å¸è½½æ—¶ DeleteGlobalRefã€‚ return JNI_TRUE;}// -------------------- JNI_OnLoadï¼šåº“è¢« System.loadLibrary æ—¶ JVM è°ƒç”¨ --------------------JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM* vm, void* reserved) { JNIEnv* env = NULL; // è·å– JNIEnv æŒ‡é’ˆ â€”â€” æ³¨æ„çº¿ç¨‹å®‰å…¨ä¸è¿”å›å€¼æ£€æŸ¥ if ((*vm)-&gt;GetEnv(vm, (void**)&amp;env, JNI_VERSION_1_6) != JNI_OK) { return JNI_ERR; // è¡¨ç¤ºåŠ è½½å¤±è´¥ } // æ³¨å†Œ native æ–¹æ³•ï¼ˆé€šå¸¸åœ¨è¿™é‡Œåšï¼Œä½† Android æƒ…å†µè§åæ–‡ï¼‰ if (!register_native_methods(env)) { return JNI_ERR; // æ³¨å†Œå¤±è´¥ï¼Œè¿”å›é”™è¯¯ä½¿åŠ è½½å¤±è´¥ } // è¿”å›æ‰€æ”¯æŒçš„ JNI ç‰ˆæœ¬ return JNI_VERSION_1_6;}#ifdef __cplusplus} // extern &quot;C&quot;#endif æ³¨æ„ï¼Œè¿™é‡Œçš„register_native_methodså¹¶ä¸æ˜¯å¿…é¡»è¦å†™çš„ï¼Œå®ƒçš„ä½œç”¨åªæ˜¯è®©ä»£ç ç»“æ„æ›´æ¸…æ™° ä¸€ä¸ªå…¸å‹çš„è¾…åŠ©å‡½æ•° 1234567891011static int register_native_methods(JNIEnv* env, const char* className, JNINativeMethod* methods, int numMethods) { jclass clazz = (*env)-&gt;FindClass(env, className); if (clazz == NULL) { return JNI_FALSE; } if ((*env)-&gt;RegisterNatives(env, clazz, methods, numMethods) &lt; 0) { return JNI_FALSE; } return JNI_TRUE;} è€ŒJni_Onloadæ˜¯å¿…é¡»çš„ åœ¨Javaå±‚æ‰§è¡Œsystem.loadLibraryçš„æ—¶å€™è¢«Jvmè‡ªåŠ¨è°ƒç”¨ï¼Œå½“ native åº“è¢«åŠ è½½æ—¶ï¼Œå®Œæˆåˆå§‹åŒ–ï¼Œæ¯”å¦‚æ³¨å†Œ native å‡½æ•°ã€‚ JNI_OnLoadçš„æ ‡å‡†å†™æ³• 123456789101112131415161718JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM* vm, void* reserved){ JNIEnv* env = NULL; // 1. è·å– JNIEnv æŒ‡é’ˆ if ((*vm)-&gt;GetEnv(vm, (void**)&amp;env, JNI_VERSION_1_6) != JNI_OK) { return JNI_ERR; } // 2. è°ƒç”¨è‡ªå·±å†™çš„æ³¨å†Œå‡½æ•°ï¼ˆå¯é€‰ï¼‰ if (!register_native_methods(env, &quot;com/example/MyClass&quot;, methods, sizeof(methods) / sizeof(methods[0]))) { return JNI_ERR; } // 3. è¿”å› JNI ç‰ˆæœ¬å·ï¼ˆå¿…é¡»ï¼‰ return JNI_VERSION_1_6;} åœ¨åŠ¨æ€æ³¨å†Œä¸­ï¼Œæ ¸å¿ƒå‡½æ•°æ˜¯ 1jint RegisterNatives(JNIEnv* env, jclass clazz, const JNINativeMethod* methods, jint nMethods); æ³¨æ„ï¼Œè¿™ä¸ªmethodså‚æ•°ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç±»å‹ä¸º 12345typedef struct { const char* name; // Java æ–¹æ³•å const char* signature; // Java æ–¹æ³•ç­¾åï¼ˆæè¿°å‚æ•°ä¸è¿”å›å€¼ç±»å‹ï¼‰ void* fnPtr; // å¯¹åº”çš„ C å‡½æ•°æŒ‡é’ˆ} JNINativeMethod; å¦‚æœä¸ä¼ è¿™ä¸ªè¡¨ï¼ŒRegisterNatives()å°±ä¸çŸ¥é“åœ¨æ³¨å†Œä»€ä¹ˆä¸œè¥¿ æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´ï¼Œä»é€»è¾‘ä¸Šæ¥çœ‹ï¼Œæ–¹æ³•è¡¨æ˜¯ä¸€ä¸ªå¿…é¡»çš„ä¸œè¥¿ æ–¹æ³•è¡¨çš„ç»“æ„å¦‚ä¸‹ 1234static JNINativeMethod methods[] = { {&quot;sayHello&quot;, &quot;()V&quot;, (void*)native_sayHello}, {&quot;add&quot;, &quot;(II)I&quot;, (void*)native_add}}; â€œsayHelloâ€è¿™ä¸ªå­—æ®µè¡¨ç¤ºå‡½æ•°å â€œ()Vâ€è¿™ä¸ªå­—æ®µè¡¨ç¤ºvoid (void*)native_sayHelloå­—æ®µè¡¨ç¤ºå‡½æ•°åœ°å€ ç¬¬äºŒä¸ªå­—æ®µçš„å¸¸è§ç­¾åæ–¹æ³•å¦‚ä¸‹ Java ç±»å‹ -&gt; JNI ç­¾å â€‹void -&gt; Vâ€‹ â€‹boolean -&gt; Zâ€‹ â€‹byte -&gt; Bâ€‹ â€‹char -&gt; Câ€‹ â€‹short -&gt; Sâ€‹ â€‹int -&gt; Iâ€‹ â€‹long -&gt; Jâ€‹ â€‹float -&gt; Fâ€‹ â€‹double -&gt; Dâ€‹ â€‹Object -&gt; Lfull/package/ClassName; ï¼ˆåŒ…åç”¨ /ï¼Œä¾‹å¦‚ Ljava/lang/String;ï¼‰ â€‹int[] -&gt; [Iã€String[] -&gt; [Ljava/lang/String;â€‹ ä¸¾ä¾‹ï¼š â€‹void foo() -&gt; ()Vâ€‹ â€‹int sum(int a, int b) -&gt; (II)Iâ€‹ â€‹String process(String s, int[] arr) -&gt; (Ljava/lang/String;[I)Ljava/lang/String;â€‹ â€ é€†å‘åŒæ ·å¯ä»¥çœ‹åˆ°æ³¨å†Œäº†ä¸ªnativeå‡½æ•° åˆ°äº†nativeå±‚ï¼Œå¯ä»¥å‘ç°å¤§ä¸åŒäº† é¦–å…ˆå¯ä»¥çœ‹åˆ°JNI_Onloadå‡½æ•°ï¼Œçœ‹ä¸åˆ°é™æ€æ³¨å†Œæ ¼å¼å‘½åçš„å‡½æ•°åäº† é‚£ä¹ˆåº”è¯¥æ€æ ·çœ‹åŠ¨æ€æ³¨å†Œäº†å“ªäº›å‡½æ•°å‘¢ è¿˜è®°å¾—å—ï¼Œåœ¨æºç ä¸­ï¼Œæˆ‘ä»¬æ˜¯å†™äº†ä¸€ä¸ªâ€œå‡½æ•°è¡¨â€çš„ åœ¨IDAä¸­ï¼Œå¦‚æœæ²¡å»ç¬¦å·è¡¨ï¼Œæ˜¯å¯ä»¥çœ‹åˆ°çš„ æˆ‘ä»¬ç‚¹è¿›å»ï¼Œå°±å¯ä»¥çœ‹åˆ°åŠ¨æ€æ³¨å†Œäº†å“ªäº›å‡½æ•°äº† â€","link":"/2025/10/15/Native%E5%87%BD%E6%95%B0%E6%B3%A8%E5%86%8C/"},{"title":"Fridaæ“ä½œå¤§å…¨","text":"Frida Labså…¨è§£ Frida labså‚æ•°è§£é‡Š12345-U æŒ‡å®šUSBè®¾å¤‡-f æŒ‡å®šappåŒ…åï¼Œé€šè¿‡spawnæ–¹å¼å¯åŠ¨ï¼ˆå°±æ˜¯é‡æ–°å¯åŠ¨çš„æ„æ€ï¼‰-P æŒ‡å®šAPPçš„pid--no-pause ä¸æš‚åœ-l åŠ è½½hookè„šæœ¬ â€ 0x1 Hookä¿®æ”¹è¢«è°ƒç”¨çš„æ–¹æ³•çš„é€»è¾‘ï¼Œè¿”å›å€¼ï¼Œä¼ å…¥å‚æ•°ä½¿ç”¨éšæœºæ•°ï¼Œå¯¹è¾“å…¥è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¾“å…¥æ•°çš„æ»¡è¶³ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå°±ä¼šæ‰“å°å‡ºflag äºæ˜¯è¿™é‡Œå°±æœ‰ä¸¤ç§æ€è·¯äº†ã€‚ç¬¬ä¸€ç§æ˜¯ hook get_random å‡½æ•°ï¼Œè®©è¯¥å‡½æ•°çš„è¿”å›å€¼å˜æˆä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œä»è€Œè®¡ç®—è¡¨è¾¾å¼çš„å€¼ ç¬¬äºŒç§æ€è·¯æ˜¯ hook check å‡½æ•°ï¼Œç›´æ¥å°†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å€¼ä¼ å…¥è¿›å» 12345678910111213141516171819202122232425function hook() { var MainActivity = Java.use(&quot;com.ad2001.frida0x1.MainActivity&quot;); //ä½¿ç”¨ Frida çš„ Java.use() æ–¹æ³•è·å–ç›®æ ‡ç±» MainActivity çš„å¼•ç”¨ã€‚ MainActivity.get_random.implementation = function () { //implementation åœ¨ Frida ä¸­æ˜¯ä¸€ä¸ªå…³é”®å±æ€§ï¼Œç”¨äºè¦†ç›–åŸå§‹ Java æ–¹æ³•çš„å®ç° return 0; }}function hook2() { var MainActivity = Java.use(&quot;com.ad2001.frida0x1.MainActivity&quot;); MainActivity.check.overload('int', 'int').implementation = function (a, b) { //overloadç”¨äºæŒ‡å®šå‚æ•°ï¼Œç”±äºJavaçš„æ–¹æ³•å¯ä»¥é‡è½½ï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®š console.log(&quot;Origin i and i2 = &quot;, a, b); //console.logæ‰“å° return this.check(3, b); //æˆ‘ä»¬è‡ªå·±å°† i çš„å€¼å®šä¸º 3 ä¼ å…¥è¿›å» }}function main() { Java.perform(function () { hook2(); })}setImmediate(main); æ³¨å…¥ 1frida -U -f com.ad2001.frida0x1 -l hook.js -U -f ç¼ºä¸€ä¸å¯ ä¸ºä»€ä¹ˆ ç¼ºå°‘ -f 12345678910111213C:\\Users\\29660\\Desktop\\Frida\\Frida-Labs-main\\Frida-Labs-main\\Frida 0x1&gt;frida -U com.ad2001.frida0x1 -l hook.js ____ / _ | Frida 16.4.10 - A world-class dynamic instrumentation toolkit | (_| | &gt; _ | Commands: /_/ |_| help -&gt; Displays the help system . . . . object? -&gt; Display information about 'object' . . . . exit/quit -&gt; Exit . . . . . . . . More info at https://frida.re/docs/home/ . . . . . . . . Connected to Android Emulator 5554 (id=emulator-5554)Failed to spawn: unable to find process with name 'com.ad2001.frida0x1' Failed to spawn: unable to find process with name â€˜com.ad2001.frida0x1â€™è¡¨ç¤ºæ²¡æœ‰Frida æ‰¾ä¸åˆ°åä¸º â€‹com.ad2001.frida0x1â€‹ çš„è¿›ç¨‹ï¼Œè¯¦è§lab02 â€ ç¼ºå°‘-U 12345678910111213C:\\Users\\29660\\Desktop\\Frida\\Frida-Labs-main\\Frida-Labs-main\\Frida 0x1&gt;frida -f com.ad2001.frida0x1 -l hook.js ____ / _ | Frida 16.4.10 - A world-class dynamic instrumentation toolkit | (_| | &gt; _ | Commands: /_/ |_| help -&gt; Displays the help system . . . . object? -&gt; Display information about 'object' . . . . exit/quit -&gt; Exit . . . . . . . . More info at https://frida.re/docs/home/ . . . . . . . . Connected to Local System (id=local)Failed to spawn: unable to find executable at 'com.ad2001.frida0x1' è¯´æ˜ Frida æ²¡æœ‰è¿æ¥åˆ° Android æ¨¡æ‹Ÿå™¨ï¼Œè€Œæ˜¯è¿æ¥åˆ°äº†ä½ æœ¬åœ°ç”µè„‘ï¼ˆWindowsï¼‰ï¼Œæ‰€ä»¥å®ƒä»¥ä¸ºæ˜¯è¦åœ¨æœ¬åœ°è¿è¡Œä¸€ä¸ªå« com.ad2001.frida0x1 çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ â€ 0x2 Hookè°ƒç”¨é™æ€çš„æœªè¢«è°ƒç”¨çš„æ–¹æ³•å¯ä»¥çœ‹åˆ°è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª get_flag æ–¹æ³•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨ä¸»å‡½æ•°ä¸­è¢«è°ƒç”¨ ä½¿ç”¨ frida ç›´æ¥è°ƒç”¨æœªè¢«è°ƒç”¨çš„é™æ€æ–¹æ³• 12345678910111213141516171819202122232425setImmediate(function () { Java.perform(function () { var a = Java.use(&quot;com.ad2001.frida0x2.MainActivity&quot;) a.get_flag(4919); })})function hook() { var MainActivity = Java.use(&quot;com.ad2001.frida0x2.MainActivity&quot;); MainActivity.get_flag(4919);}function main() { Java.perform(function () { hook(); })}setImmediate(main); hookçš„æ—¶å€™ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æœ‰å¯èƒ½ä¼šhookä¸ä¸Š 1frida -U -f com.ad2001.frida0x2 -l hook.js åŸå› æ˜¯setImmediate(main);æ˜¯ç¨‹åºå¯åŠ¨åç«‹å³æ³¨å…¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿˜æ²¡å®Œå…¨å¯åŠ¨å°±æ³¨å…¥äº†ï¼Œæ‰€ä»¥hookä¸ä¸Š è§£å†³åŠæ³•æ˜¯ä½¿ç”¨ 1frida -U 'frida 0x2' -l hook.js é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå°†frida 0x2å†™æˆåŒ…åcom.ad2001.frida0x2å°±ä¸è¡Œå‘¢ 1frida -U com.ad2001.frida0x2 -l hook.js è¿™ä¸ªå‘½ä»¤å°è¯•çš„æ˜¯ï¼šæ ¹æ®åŒ…åæ³¨å…¥ï¼Œé»˜è®¤æ˜¯ spawnï¼ˆå¯åŠ¨ï¼‰æ¨¡å¼ã€‚ å®é™…ä¸Šè¿™æ¡å‘½ä»¤æ˜¯å°è¯• spawnï¼ˆå¯åŠ¨ï¼‰åŒ…åå¯¹åº”çš„ appï¼Œä½†æ²¡å†™ -fï¼Œå®ƒåˆä¸æ˜¯ attach æ¨¡å¼ï¼Œå°±ä¼šå¤±è´¥ã€‚ æˆ–è€…å°†hookä»£ç ä¸­çš„ setImmediate(main);æ”¹æˆ setTimeout(main,1000);å»¶è¿Ÿå¯åŠ¨ 12345678910111213function hook() { var MainActivity = Java.use(&quot;com.ad2001.frida0x2.MainActivity&quot;); MainActivity.get_flag(4919);}function main() { Java.perform(function () { hook(); })}// setImmediate(main);setTimeout(main, 1000); â€ 0x3 æ›´æ”¹ç±»ä¸­çš„é™æ€å˜é‡hook codeçš„å€¼ 1234567891011121314function hook() { var a = Java.use(&quot;com.ad2001.frida0x3.Checker&quot;) //codeçš„å€¼åœ¨Checkerç±»é‡Œ a.code.value = 512; //ä½¿ç”¨è¿™ä¸€å¥ä¿®æ”¹é™æ€å˜é‡çš„å€¼}function main() { Java.perform(function () { hook(); })}setImmediate(main); æ€è€ƒï¼š aæ˜¯ä»€ä¹ˆ a.code.valueå…·ä½“æ˜¯ä»€ä¹ˆæ„æ€ ä»¥ä¸‹å†…å®¹æ¥è‡ªGPT åœ¨è¿™æ®µ Frida è„šæœ¬ä¸­ï¼š 1var a = Java.use(&quot;com.ad2001.frida0x3.Checker&quot;) a æ˜¯ä»€ä¹ˆï¼ŸğŸ‘‰ â€‹aâ€‹ æ˜¯ä¸€ä¸ª Frida åˆ›å»ºçš„ Java ç±»ä»£ç†å¯¹è±¡ï¼ˆJava class wrapperï¼‰ ï¼Œä½ å¯ä»¥æŠŠå®ƒå½“æˆæ˜¯ä¸€ä¸ªâ€œæ§åˆ¶å™¨â€æˆ–è€…â€œä»£ç†â€ï¼Œç”¨æ¥è®¿é—®å’Œæ“ä½œ Java ä¸­çš„ç±» com.ad2001.frida0x3.Checker çš„é™æ€å­—æ®µã€é™æ€æ–¹æ³•ã€å®ä¾‹æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥ hook å®ƒçš„æ–¹æ³•ã€‚ ç±»æ¯”ä¸€ä¸‹ï¼šåœ¨ Java ä»£ç ä¸­ä½ å¯èƒ½ä¼šè¿™æ ·ç”¨ä¸€ä¸ªç±»ï¼š 1Checker.code = 512; åœ¨ Frida ä¸­ï¼Œä¸ºäº†è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œæˆ‘ä»¬å†™ï¼š 12var a = Java.use(&quot;com.ad2001.frida0x3.Checker&quot;)a.code.value = 512; æ›´å…·ä½“åœ°è¯´ï¼š â€‹Java.use(&quot;...&quot;) ä¼šè¿”å›ä¸€ä¸ª Frida çš„ Java ç±»æ¥å£ï¼ˆwrapperï¼‰ è¿™ä¸ªå¯¹è±¡ä¸æ˜¯ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯ä»¥æ“ä½œ ç±»æœ¬èº«ï¼ˆé™æ€æˆå‘˜ï¼‰æˆ–åˆ›å»ºå®ä¾‹ çš„å¯¹è±¡ã€‚ å¦‚æœä½ éœ€è¦åˆ›å»ºç±»çš„å®ä¾‹ï¼Œä½ å¯ä»¥è¿™æ ·å†™ï¼š 1var instance = a.$new(); // ç­‰äº Java é‡Œçš„ new Checker() æ‰€ä»¥æ€»ç»“ä¸€ä¸‹ï¼š åç§° è§£é‡Š â€‹aâ€‹ Frida ä¸­çš„ç±»åŒ…è£…å¯¹è±¡ï¼Œè¡¨ç¤ºCheckerç±» â€‹a.code.valueâ€‹ è¡¨ç¤ºè®¿é—®å¹¶ä¿®æ”¹ç±»ä¸­codeè¿™ä¸ªé™æ€å­—æ®µçš„å€¼ â€‹a.$new()â€‹ ï¼ˆå¯é€‰ï¼‰è¡¨ç¤ºåˆ›å»ºè¿™ä¸ªç±»çš„ä¸€ä¸ªæ–°å®ä¾‹ â€ 0x4 è°ƒç”¨éMainActivity,éé™æ€æ–¹æ³•â€‹MainActivityé‡Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿ å®šä¹‰äº†ä¸€ä¸ªCheckç±»ï¼Œé‡Œé¢æœ‰get_flagæ–¹æ³• æƒ³è°ƒç”¨è¿™ä¸ªget_flagæ–¹æ³•ï¼Œå¿…é¡»å®ä¾‹åŒ–ä¸€ä¸ªcheckç±»å¯¹è±¡ï¼Œåœ¨fridaä¸­å¯ä»¥ç”¨ä»¥ä¸‹è„šæœ¬å®ç° 123456789101112131415161718function hook() { var c = Java.use(&quot;com.ad2001.frida0x4.Check&quot;); var c_check = c.$new(); //å®ä¾‹åŒ–checkç±»å¯¹è±¡ ç›¸å½“äºJavaé‡Œå†™ c c_check = new c(); var flag = c_check.get_flag(1337); console.log(flag);}function main() { Java.perform(function () { hook(); })}setImmediate(main); è¿è¡Œç»“æœå¦‚ä¸‹ 0x5 è°ƒç”¨MainActivityä¸­çš„éé™æ€æ–¹æ³•åœ¨ 0x2 ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨fridaè°ƒç”¨äº†é™æ€æ–¹æ³• ä½†åœ¨æœ¬æ¬¡ï¼Œè¿™æ˜¯ä¸€ä¸ªéé™æ€æ–¹æ³• Javaä¸­é™æ€æ–¹æ³•å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œè€Œéé™æ€æ–¹æ³•å¿…é¡»å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ä¹‹åæ‰èƒ½è°ƒç”¨ 123456789101112131415161718192021public class Hello { // é™æ€æ–¹æ³• public static void sayStatic() { System.out.println(&quot;æˆ‘æ˜¯é™æ€æ–¹æ³•&quot;); } // éé™æ€æ–¹æ³• public void sayInstance() { System.out.println(&quot;æˆ‘æ˜¯éé™æ€æ–¹æ³•&quot;); } public static void main(String[] args) { // è°ƒç”¨é™æ€æ–¹æ³•ï¼šä¸éœ€è¦åˆ›å»ºå¯¹è±¡ Hello.sayStatic(); // è°ƒç”¨éé™æ€æ–¹æ³•ï¼šå¿…é¡»å…ˆåˆ›å»ºå¯¹è±¡ Hello h = new Hello(); h.sayInstance(); }} æˆ‘ä»¬ç›´æ¥ç”¨ 0x2 çš„è„šæœ¬hookä¸€ä¸‹ 123456789101112function hook() { var MainActivity = Java.use(&quot;com.ad2001.frida0x5.MainActivity&quot;); MainActivity.flag(1337);}function main() { Java.perform(function () { hook(); })}setImmediate(main); å“¦è±ï¼ŒæŠ¥é”™äº† ä»¥ä¸‹è§£é‡Šæ¥è‡ªSWDDå¸ˆå‚… ç›´æ¥ä½¿ç”¨Fridaåˆ›å»ºMainActivityæˆ–ä»»ä½•Androidç»„ä»¶å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ï¼Œå› ä¸ºAndroidçš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹è§„åˆ™ã€‚Androidç»„ä»¶ï¼Œå¦‚Activityå­ç±»ï¼Œä¾èµ–äºåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡è¿›è¡Œæ­£ç¡®è¿è¡Œã€‚åœ¨Fridaä¸­ï¼Œæ‚¨å¯èƒ½ç¼ºå°‘å¿…è¦çš„ä¸Šä¸‹æ–‡ã€‚Android UIç»„ä»¶é€šå¸¸éœ€è¦å…·æœ‰å…³è”Looperçš„ç‰¹å®šçº¿ç¨‹ã€‚å¦‚æœæ¶‰åŠUIä»»åŠ¡ï¼Œè¯·ç¡®ä¿åœ¨å…·æœ‰æ´»åŠ¨Looperçš„ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚æ´»åŠ¨æ˜¯è¾ƒå¤§çš„Androidåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„ä¸€éƒ¨åˆ†ã€‚åˆ›å»ºMainActivityçš„å®ä¾‹å¯èƒ½éœ€è¦åº”ç”¨å¤„äºç‰¹å®šçŠ¶æ€ï¼Œå¹¶ä¸”é€šè¿‡Fridaç®¡ç†æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯èƒ½å¹¶ä¸ç›´æ¥ã€‚æ€»ä¹‹ï¼Œä¸ºMainActivityåˆ›å»ºå®ä¾‹å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ é€šä¿—ç‚¹æ¥è¯´å°±æ˜¯ï¼Œ ç”¨Fridaç›´æ¥åˆ›å»º MainActivity æˆ–å…¶ä»– Android ç»„ä»¶ï¼ˆæ¯”å¦‚ Activityï¼‰æ˜¯å¾ˆéº»çƒ¦çš„ï¼Œç”šè‡³æ˜¯ä¸å¯è¡Œçš„ã€‚ åŸå› æ˜¯è¿™æ ·çš„ï¼š Activity éœ€è¦ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰æ‰èƒ½æ­£å¸¸å·¥ä½œï¼šå°±åƒä½ é€ æˆ¿å­è¦æœ‰åœ°åŸºä¸€æ ·ï¼ŒActivity è¿™ç§ç»„ä»¶è¿è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ä¾èµ–åº”ç”¨ç¨‹åºæä¾›çš„è¿è¡Œç¯å¢ƒï¼ˆå°±æ˜¯ Contextï¼‰ã€‚åœ¨ Frida é‡Œï¼Œä½ æ˜¯â€œæ—è§‚è€…â€ï¼Œè€Œä¸æ˜¯â€œæˆ¿å­çš„ä¸»äººâ€ï¼Œæ‰€ä»¥æ²¡æ³•è½»æ¾æä¾›è¿™ä¸ªç¯å¢ƒã€‚ UI ç›¸å…³çš„ä»£ç å¿…é¡»åœ¨ä¸»çº¿ç¨‹ï¼ˆå¸¦ Looper çš„çº¿ç¨‹ï¼‰é‡Œè·‘ï¼šAndroid è¦æ±‚æ‰€æœ‰è·Ÿç•Œé¢æœ‰å…³çš„æ“ä½œéƒ½å¾—åœ¨â€œä¸»çº¿ç¨‹â€é‡Œè¿è¡Œï¼Œè¿™ä¸ªçº¿ç¨‹æœ‰ä¸ªå« Looper çš„æ¶ˆæ¯å¾ªç¯ç³»ç»Ÿã€‚åœ¨ Frida é‡Œï¼Œå¦‚æœä½ éšä¾¿åœ¨å“ªä¸ªçº¿ç¨‹é‡Œè·‘ UI ä»£ç ï¼Œç¨‹åºå¾ˆå¯èƒ½ç›´æ¥å´©æ‰ã€‚ Activity çš„ç”Ÿå‘½å‘¨æœŸå¾ˆå¤æ‚ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¸® Activity è°ƒç”¨ä¸€ç³»åˆ—æ–¹æ³•ï¼Œæ¯”å¦‚ onCreateã€onStartã€onResume ç­‰ã€‚è¿™ä¸€æ•´å¥—æµç¨‹æ˜¯ç³»ç»Ÿæ§åˆ¶çš„ã€‚å¦‚æœä½ è‡ªå·±ç”¨ Frida å»â€œå¼ºè¡Œâ€åˆ›å»ºä¸€ä¸ª Activity å®ä¾‹ï¼Œç³»ç»Ÿå…¶å®å¹¶ä¸çŸ¥é“å®ƒå­˜åœ¨ï¼Œæ‰€ä»¥å®ƒæ— æ³•æ­£å¸¸å·¥ä½œã€‚ é‚£ä¹ˆåº”è¯¥æ€ä¹ˆåŠå‘¢ SWDDè¯´ å½“Androidåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºMainActivityçš„ä¸€ä¸ªå®ä¾‹ï¼ˆæˆ–AndroidManifest.xmlæ–‡ä»¶ä¸­æŒ‡å®šçš„å¯åŠ¨å™¨æ´»åŠ¨ï¼‰ã€‚åˆ›å»ºMainActivityå®ä¾‹æ˜¯Androidåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨fridaè·å–MainActivityçš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨flag()æ–¹æ³•æ¥è·å–æˆ‘ä»¬çš„æ ‡å¿—ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹GPTæ€ä¹ˆè¯´ ğŸ“± æ­£å¸¸æ¥è¯´ï¼ŒAndroid åº”ç”¨æ˜¯æ€ä¹ˆå¯åŠ¨çš„ï¼Ÿ å½“ä½ ç‚¹å‡»æŸä¸ª App å›¾æ ‡æ—¶ï¼Œ Android ç³»ç»Ÿå°±ä¼šå»çœ‹è¿™ä¸ª App çš„ AndroidManifest.xml æ–‡ä»¶ï¼Œ æ‰¾åˆ°æ ‡æ³¨ä¸ºã€Œå¯åŠ¨å…¥å£ã€çš„ Activityï¼ˆæ¯”å¦‚ MainActivityï¼‰ï¼Œ ç„¶åç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ª Activity çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å®ƒçš„ä¸€ç³»åˆ—ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆæ¯”å¦‚ onCreate()ã€onResume() ç­‰ï¼‰ã€‚ ğŸ§  é‚£è¿™æ®µè¯çš„æ ¸å¿ƒæ„æ€å°±æ˜¯ï¼š ä½ è‡ªå·±ä¸ç”¨ new ä¸€ä¸ª MainActivityï¼Œç³»ç»Ÿå·²ç»å¸®ä½ åˆ›å»ºå¥½äº†ï¼ æ‰€ä»¥ä¸å…¶è‡ªå·±åˆ›å»ºä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„å®ä¾‹ï¼ˆä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼‰ï¼Œä¸å¦‚ç›´æ¥å»â€œæ‹¿åˆ°â€ç³»ç»Ÿå·²ç»åˆ›å»ºçš„é‚£ä¸ªå®ä¾‹ï¼Œç„¶åè°ƒç”¨ä½ æƒ³è¦çš„å‡½æ•°ï¼Œæ¯”å¦‚ â€‹flag()â€‹ â€‹ ã€‚ âœ… æ€»ç»“ä¸€ä¸‹ï¼Œé€šä¿—ç‚¹è¯´å°±æ˜¯ï¼š â€œAndroid ç³»ç»Ÿä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»º MainActivity çš„å®ä¾‹ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦è‡ªå·±é€ ä¸€ä¸ªã€‚ç”¨ Frida å¯ä»¥ç›´æ¥æ‰¾åˆ°è¿™ä¸ªå·²ç»å­˜åœ¨çš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨ä½ æƒ³è¦çš„æ–¹æ³•ï¼ˆæ¯”å¦‚ â€‹flag()â€‹ â€‹ ï¼‰æ¥æ‹¿ flagã€‚â€ æœ‰è¿™æ ·ä¸€ä¸ªæ¨¡æ¿ 12345678Java.performNow(function() { Java.choose('&lt;åŒ…å&gt;.&lt;ç±»å&gt;', { onMatch: function(instance) { // å¾…åŠäº‹é¡¹ }, onComplete: function() {} });}); onMatch â€‹onMatchå›è°ƒå‡½æ•°åœ¨Java.chooseæ“ä½œæœŸé—´æ‰¾åˆ°æŒ‡å®šç±»çš„æ¯ä¸ªå®ä¾‹æ—¶æ‰§è¡Œã€‚ è¿™ä¸ªå›è°ƒå‡½æ•°æ¥æ”¶å½“å‰å®ä¾‹ä½œä¸ºå®ƒçš„å‚æ•°ã€‚ æ‚¨å¯ä»¥åœ¨onMatchå›è°ƒä¸­å®šä¹‰è‡ªå®šä¹‰æ“ä½œï¼Œä»¥åœ¨æ¯ä¸ªå®ä¾‹ä¸Šæ‰§è¡Œã€‚ â€‹function(instance) {}ï¼Œinstanceå‚æ•°è¡¨ç¤ºç›®æ ‡ç±»çš„æ¯ä¸ªåŒ¹é…å®ä¾‹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–åç§°ã€‚å‚æ•° instance å°±æ˜¯è¿™ä¸ª MainActivity çš„å¯¹è±¡ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨å®ƒçš„å‡½æ•°ï¼Œæ¯”å¦‚ instance.flag()â€‹ onComplete â€‹onCompleteå›è°ƒåœ¨Java.chooseæ“ä½œå®Œæˆåæ‰§è¡Œæ“ä½œæˆ–æ¸…ç†ä»»åŠ¡ã€‚æ­¤å—æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ‚¨åœ¨æœç´¢å®Œæˆåä¸éœ€è¦æ‰§è¡Œä»»ä½•ç‰¹å®šæ“ä½œï¼Œåˆ™å¯ä»¥é€‰æ‹©å°†å…¶ç•™ç©ºã€‚ å°è¯•ä½¿ç”¨è¯¥æ¨¡æ¿å¯»æ‰¾MainActivityå®ä¾‹ 1234567891011121314151617181920function hook() { Java.choose('com.ad2001.frida0x5.MainActivity', { onMatch: function (instance) { console.log(&quot;Sucess found!!!&quot;); }, onComplete: function () { console.log(&quot;end&quot;); } });}function main() { Java.perform(function () { hook(); })}setImmediate(main); åœ¨è¿™é‡Œè¿˜å‘ç°ä¸ªé—®é¢˜ï¼Œå½“ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨fridaæ—¶ï¼Œåªä¼šæ‰“å°ä¸€ä¸ª end ï¼Œhookä¸ä¸Šï¼Œéœ€è¦é‡æ–°ä¿®æ”¹ä¸€ä¸‹è„šæœ¬ï¼ˆä¾‹å¦‚æ³¨é‡Šæ‰æŸä¸€è¡Œå†åŠ ä¸Šï¼‰ 1frida -U -f com.ad2001.frida0x5 -l lab05.js åŸå› å…¶å®è·Ÿ 0x2 ä¸€æ ·ï¼Œç”±äºè„šæœ¬æ˜¯ç«‹å³æ³¨å…¥ï¼Œappè¿˜æ¥ä¸åŠåˆ›å»ºMainActivityå®ä¾‹ï¼Œè‡ªç„¶å°±æ²¡æ‰¾åˆ° è§£å†³åŠæ³•ä¹Ÿè·Ÿ 0x2 ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿° â€ 0x6 MainActivityä¸­çš„éé™æ€æ–¹æ³•ä¸”å‚æ•°é€šè¿‡éMainActivityéé™æ€æ–¹æ³•ä¼ é€’MainActivityä¸­çš„éé™æ€æ–¹æ³• get_flag ï¼Œå¹¶ä¸”å‚æ•°æ˜¯é€šè¿‡ Checker ç±»å¯¹è±¡ A æ¥ä¼ é€’çš„ Checkerç±»å¦‚ä¸‹ æ‰€ä»¥è¿™é¢˜å°±æ˜¯0x5 0x4 0x3çš„ç»“åˆï¼Œä½†æ˜¯åœ¨ 0x3 ä¸­ï¼Œå˜é‡ä¸ºé™æ€å˜é‡ï¼Œæ‰€ä»¥éœ€è¦è¿™é‡Œéœ€è¦åˆ›å»ºä¸€ä¸ªç±»çš„å¯¹è±¡æ¥å¯¹å˜é‡è¿›è¡Œæ›´æ”¹ 12345678910111213141516171819202122232425262728293031function hook() { Java.choose(&quot;com.ad2001.frida0x6.MainActivity&quot;, { onMatch: function (MainActivity) { var c = Java.use(&quot;com.ad2001.frida0x6.Checker&quot;) var A = c.$new(); A.num1.value = 1234; A.num2.value = 4321; console.log(&quot;success&quot;); MainActivity.get_flag(A); }, onComplete: function () { console.log(&quot;end&quot;); } });}function main() { Java.perform(function () { hook(); })}// setImmediate(main);setTimeout(main, 1000); â€ 0x7 Hookæ„é€ å‡½æ•°æ„é€ å‡½æ•°æ˜¯ Java ç±»ä¸­çš„ä¸€ç§ç‰¹æ®Šæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼šåœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ç”¨æ¥åˆå§‹åŒ–å¯¹è±¡çš„å±æ€§ã€‚ å…ˆä¸¾ä¸ªä¾‹å­æ¥äº†è§£ä¸€ä¸‹æ£®è«æ˜¯Javaä¸­çš„æ„é€ å‡½æ•° 123456789101112131415161718192021222324252627public class Dog { String name; int age; // æ„é€ å‡½æ•° public Dog(String n, int a) { name = n; age = a; } // æ™®é€šæ–¹æ³• public void bark() { System.out.println(name + &quot; æ±ªæ±ªå«ï¼&quot;); } public void showInfo() { System.out.println(&quot;è¿™åªç‹—å« &quot; + name + &quot;ï¼Œå®ƒ &quot; + age + &quot; å²äº†ã€‚&quot;); } public static void main(String[] args) { Dog d = new Dog(&quot;å°é»‘&quot;, 3); // è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–å¯¹è±¡ Dogï¼ˆç¬¬ä¸€ä¸ªï¼‰ğŸ‘‰ è¡¨ç¤ºå˜é‡ d çš„ ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ç±»åï¼Œè¯´æ˜ d æ˜¯ä¸€ä¸ª Dog ç±»å‹çš„å¯¹è±¡ã€‚ //new Dog(&quot;å°é»‘&quot;, 3)ï¼ˆåé¢è¿™ä¸ªï¼‰ğŸ‘‰ æ˜¯ è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Dog å¯¹è±¡ï¼Œå¹¶ä¼ å…¥ä¸¤ä¸ªå‚æ•°ã€‚ d.bark(); // è°ƒç”¨æ™®é€šæ–¹æ³• d.showInfo(); // è°ƒç”¨æ™®é€šæ–¹æ³• }} æ¥çœ‹æœ¬é¢˜ï¼Œè°ƒç”¨äº†flagæ–¹æ³•ï¼Œå¹¶ä¸”é€šè¿‡Checkeræ„é€ å‡½æ•°å¯¹ num1 å’Œ num2 èµ‹å€¼ä¸º 123 å’Œ 321 åœ¨Fridaä¸­ä½¿ç”¨ $init å…³é”®å­—æ¥ hook æ„é€ å‡½æ•° 123456789101112131415161718192021function hook() { var Checker = Java.use(&quot;com.ad2001.frida0x7.Checker&quot;); Checker.$init.implementation = function (a, b) { // Checker.$init æ˜¯è¿™ä¸ªç±»çš„ æ„é€ å‡½æ•°ï¼ˆconstructorï¼‰ã€‚ // .implementation = function (a, b) è¡¨ç¤ºä½ è¦â€œåŠ«æŒâ€è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨ä½ è‡ªå·±çš„å®ç°æ¥æ›¿ä»£åŸæ¥çš„ã€‚ // a, b å°±æ˜¯åŸæœ¬ä¼ ç»™æ„é€ å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°ã€‚ console.log(&quot;Origin num&quot;, a, b); this.$init(666, 666); //this.$init(...) è¡¨ç¤ºâ€œç”¨åŸæœ¬çš„æ–¹å¼ç»§ç»­åˆå§‹åŒ–å¯¹è±¡ï¼Œä½†ç”¨æˆ‘ç»™çš„å‚æ•°â€ console.log(&quot;success&quot;); }}function main() { Java.perform(function () { hook(); })}setImmediate(main); å†™åˆ°è¿™æˆ‘æœ‰ç‚¹å¥½å¥‡å¦‚æœä½¿ç”¨ 0x1 çš„æ–¹æ³•ç›´æ¥å» hook æ„é€ å‡½æ•°ä¼šæ€æ · æ¥å§ï¼Œå®è·µå‡ºçœŸçŸ¥ 1234567891011121314function hook() { var Ch = Java.use(&quot;com.ad2001.frida0x7.Checker&quot;); Ch.Checker.overload('int', 'int').implementation = function (a, b) { console.log(&quot;Origin num&quot;, a, b); //console.logæ‰“å° return this.Checker(666, 666); }}function main() { Java.perform(function () { hook(); })}setImmediate(main); å“ˆå“ˆï¼ŒæŠ¥é”™äº†ï¼Œcannot read property â€˜overloadâ€™ of undefined è¯´æ˜è¯•å›¾ hook çš„ Java æ–¹æ³•å¹¶æ²¡æœ‰æ‰¾åˆ° ç„¶åæˆ‘åˆå¥½å¥‡ï¼Œå¦‚æœä½¿ç”¨ 0x3 çš„æ–¹æ³•ç›´æ¥æ”¹å˜ num1 å’Œ num2 ä¼šæ€æ · 1234567891011121314151617181920212223function hook() { var Checker = Java.use(&quot;com.ad2001.frida0x7.Checker&quot;); Checker.$init.implementation = function (a, b) { // Checker.$init æ˜¯è¿™ä¸ªç±»çš„ æ„é€ å‡½æ•°ï¼ˆconstructorï¼‰ã€‚ // .implementation = function (a, b) è¡¨ç¤ºä½ è¦â€œåŠ«æŒâ€è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨ä½ è‡ªå·±çš„å®ç°æ¥æ›¿ä»£åŸæ¥çš„ã€‚ // a, b å°±æ˜¯åŸæœ¬ä¼ ç»™æ„é€ å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°ã€‚ console.log(&quot;Origin num&quot;, a, b); // this.$init(666, 666); //this.$init(...) è¡¨ç¤ºâ€œç”¨åŸæœ¬çš„æ–¹å¼ç»§ç»­åˆå§‹åŒ–å¯¹è±¡ï¼Œä½†ç”¨æˆ‘ç»™çš„å‚æ•°â€ Checker.num1.value = 666; Checker.num2.value = 666; console.log(&quot;success&quot;); }}function main() { Java.perform(function () { hook(); })}setImmediate(main); å“ˆå“ˆï¼Œæœç„¶åˆæŠ¥é”™äº† Error: Cannot access an instance field without an instance è¡¨ç¤ºè¯•å›¾è®¿é—® Checker.num1ï¼Œä½†è¿™æ˜¯ å®ä¾‹å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰ ï¼Œä½ å¿…é¡»é€šè¿‡ä¸€ä¸ªå…·ä½“å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯ thisï¼‰æ¥è®¿é—®å®ƒ æ”¹æˆè¿™æ ·æˆ–è®¸ä¼šæ¯”åˆä»£è„šæœ¬å¥½ç†è§£ä¸€äº›ï¼Œè·Ÿ 0x1 ä¹Ÿæ›´åƒ 1234567891011121314151617181920212223function hook() { var Checker = Java.use(&quot;com.ad2001.frida0x7.Checker&quot;); Checker.$init.overload('int', 'int').implementation = function (a, b) { console.log(&quot;Origin num:&quot;, a, b); // è°ƒç”¨åŸå§‹æ„é€ å‡½æ•°åˆå§‹åŒ–å¯¹è±¡ this.$init(a, b); // ä¿®æ”¹æˆå‘˜å˜é‡ this.num1.value = 666; this.num2.value = 666; console.log(&quot;Success: num1 and num2 changed to 666&quot;); };}function main() { Java.perform(function () { hook(); })}setImmediate(main); â€ 0x8 Hook Nativeå±‚ä¸­è°ƒç”¨çš„å‡½æ•°å¹¶ä¸”è¯»å–ä¼ å…¥çš„å‚æ•°ä»æœ¬ç« å¼€å§‹è¿›å…¥ Nativeå±‚ æ¨¡æ¿å¦‚ä¸‹ 12345678910Interceptor.attach(targetAddress, { onEnter: function (args) { console.log('Entering ' + functionName); // Modify or log arguments if needed }, onLeave: function (retval) { console.log('Leaving ' + functionName); // Modify or log return value if needed }}); å®ƒçš„ä½œç”¨æ˜¯ï¼š å½“ç¨‹åºè¿è¡Œåˆ°æŸä¸ªç‰¹å®šå‡½æ•°ï¼ˆåœ°å€ä¸º â€‹targetAddressâ€‹â€‹ ï¼‰æ—¶ï¼š å‡½æ•°åˆšè¿›å…¥æ—¶ï¼ˆonEnterï¼‰ ï¼šæ‰“å°ä¸€å¥è¯ï¼Œè¯´â€œæˆ‘è¿›æ¥äº†â€ï¼› å‡½æ•°æ‰§è¡Œå®Œè¿”å›æ—¶ï¼ˆonLeaveï¼‰ ï¼šå†æ‰“å°ä¸€å¥â€œæˆ‘å‡ºå»äº†â€ã€‚ æ¯è¡Œçš„æ„æ€ 1Interceptor.attach(targetAddress, { ç”¨ Frida çš„ Interceptor.attach æ¥æ‹¦æˆªï¼ˆhookï¼‰æŸä¸ªå‡½æ•°åœ°å€ã€‚è¿™ä¸ªåœ°å€æ˜¯ä½ æƒ³è§‚å¯Ÿæˆ–ä¿®æ”¹çš„å‡½æ•°ä½ç½®ï¼ˆtargetAddressï¼‰ã€‚ 1234onEnter: function (args) { console.log('Entering ' + functionName); // Modify or log arguments if needed}, å½“ç¨‹åºåˆšè¿›å…¥è¿™ä¸ªå‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡Œ onEnter è¿™ä¸ªå›è°ƒã€‚ä½ å¯ä»¥ï¼š æ‰“å°æ—¥å¿—ï¼ˆåƒç°åœ¨è¿™æ ·æ‰“å°â€œæ­£åœ¨è¿›å…¥å‡½æ•°â€ï¼‰ï¼› æŸ¥çœ‹å’Œä¿®æ”¹ä¼ å…¥å‚æ•°ï¼ˆargs æ˜¯å‚æ•°åˆ—è¡¨ï¼‰ã€‚ â€ 1234onLeave: function (retval) { console.log('Leaving ' + functionName); // Modify or log return value if needed} å½“å‡½æ•°æ‰§è¡Œå®Œå‡†å¤‡è¿”å›æ—¶ï¼Œä¼šæ‰§è¡Œ onLeaveã€‚ä½ å¯ä»¥ï¼š æ‰“å°è¿”å›å€¼ï¼› ä¿®æ”¹è¿”å›å€¼ï¼ˆretval æ˜¯è¿”å›å€¼ï¼‰ã€‚ â€ éœ€è¦è·å–targetAddressæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹API â€‹Module.enumerateExports() é€šè¿‡è°ƒç”¨ Module.enumerateExports()ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°å¯¼å‡ºå‡½æ•°çš„åç§°ã€åœ°å€ä»¥åŠå…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯¹äºè¿›è¡Œå‡½æ•°æŒ‚é’©ã€å‡½æ•°è·Ÿè¸ªæˆ–è€…è°ƒç”¨å…¶ä»–å‡½æ•°éƒ½éå¸¸æœ‰ç”¨ã€‚ â€‹Module.getExportByName() å½“æˆ‘ä»¬çŸ¥é“è¦æŸ¥æ‰¾çš„å¯¼å‡ºé¡¹çš„åç§°ä½†ä¸çŸ¥é“å…¶åœ°å€æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Module.getExportByName()ã€‚é€šè¿‡æä¾›å¯¼å‡ºé¡¹çš„åç§°ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸è¯¥åç§°å¯¹åº”çš„å¯¼å‡ºé¡¹çš„åœ°å€ã€‚ â€‹Module.findExportByName() è¿™ä¸ Module.getExportByName() æ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œå¦‚æœæœªæ‰¾åˆ°å¯¼å‡ºé¡¹ï¼ŒModule.getExportByName() ä¼šå¼•å‘å¼‚å¸¸ï¼Œè€Œ Module.findExportByName() å¦‚æœæœªæ‰¾åˆ°å¯¼å‡ºé¡¹åˆ™è¿”å› nullâ€‹ â€‹Module.getBaseAddress() é€šè¿‡è°ƒç”¨ Module.getBaseAddress() å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è·å–æŒ‡å®šæ¨¡å—çš„åŸºå€åœ°å€ï¼Œç„¶åå¯ä»¥åŸºäºè¿™ä¸ªåŸºå€åœ°å€è¿›è¡Œåç§»è®¡ç®—ï¼Œä»¥å®šä½æ¨¡å—å†…éƒ¨çš„ç‰¹å®šå‡½æ•°ã€å˜é‡æˆ–è€…æ•°æ®ç»“æ„ â€‹Module.enumerateImports() é€šè¿‡è°ƒç”¨ Module.enumerateImports() å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°æŒ‡å®šæ¨¡å—å¯¼å…¥çš„å¤–éƒ¨å‡½æ•°æˆ–å˜é‡çš„åç§°ã€åœ°å€ä»¥åŠå…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚ â€ ä½¿ç”¨ Module.enumerateImports(â€œlibfrida0x8.soâ€) æŸ¥çœ‹å¯¼å…¥è¡¨ ä½¿ç”¨Module.findExportByName(â€œlibc.soâ€,â€strcmpâ€);æ¥è·å–strcmpçš„åœ°å€ æ¥çœ‹è¿™é¢˜ åŠ è½½äº†ä¸€ä¸ª frida0x8 soæ–‡ä»¶é‡Œæœ‰ä¸€ä¸ª strcmp å‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•° s2 å°±æ˜¯ç»è¿‡å¤„ç†åçš„æ­£ç¡®çš„ flag ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠstrcmpå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°hookå‡ºæ¥ æˆ‘å…ˆæŒ‰ç…§æˆ‘è‡ªå·±çš„æƒ³æ³•å†™äº†ä¸€ä¸ªè„šæœ¬ 1234567891011121314151617181920212223function hook() { var target = Module.findExportByName(&quot;libc.so&quot;, &quot;strcmp&quot;); //æŸ¥æ‰¾strcmpçš„åœ°å€ console.log(&quot;strcmp addr is :&quot;, target.toString(16)); Interceptor.attach(target, { onEnter: function (args) { console.log(Memory.readUtf8String(args[1])); //æ‰“å°strcmpçš„ç¬¬äºŒä¸ªå‚æ•° }, onLeave: function (retval) { } })}function main() { Java.perform(function () { hook(); })}setImmediate(main); è¾“å‡ºå¦‚ä¸‹ è¿™é‡Œå…¶å®æ˜¯å› ä¸ºï¼Œæˆ‘ä»¥ä¸ºæˆ‘hookçš„æ˜¯ç‰¹å®šçš„æŸä¸€ä¸ªstrcmpï¼Œå®é™…ä¸Šè¿™ä¸ª hook æ˜¯ç”Ÿæ•ˆäºæ‰€æœ‰è°ƒç”¨ libc.so!strcmp çš„åœ°æ–¹ï¼Œæ— è®ºæ˜¯ native è°ƒç”¨è¿˜æ˜¯é€šè¿‡ JNI è¢« Java è°ƒç”¨çš„ native æ–¹æ³•ï¼Œéƒ½ä¼šè¢«æ‹¦æˆª æ‰€ä»¥å¯¼è‡´äº†è¿™ç§æƒ…å†µ æ‰€ä»¥è¦åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå½“strcmpçš„ç¬¬ä¸€ä¸ªå‚æ•°åŒ…å«æŸä¸ªæ•°ï¼ˆä¾‹å¦‚666ï¼‰æ—¶ï¼Œå°±æ‰“å°ç¬¬äºŒä¸ªå‚æ•°çš„ç»“æœï¼Œä½¿æˆ‘ä»¬çš„ç›®æ ‡æ›´åŠ â€œç²¾ç¡®â€ ä¿®æ”¹è„šæœ¬å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829function hook() { var target = Module.findExportByName(&quot;libc.so&quot;, &quot;strcmp&quot;); //æŸ¥æ‰¾strcmpçš„åœ°å€ console.log(&quot;strcmp addr is :&quot;, target.toString(16)); Interceptor.attach(target, { onEnter: function (args) { //argsåªæ˜¯æˆ‘å¯¹å‚æ•°èµ·çš„åå­—ï¼Œå¯ä»¥æ”¹æˆä»»ä½•åˆ«çš„ var input = Memory.readUtf8String(args[0]); if (input.includes(&quot;666&quot;)) { console.log(Memory.readUtf8String(args[1])); //æ‰“å°strcmpçš„ç¬¬äºŒä¸ªå‚æ•° } }, onLeave: function (retval) { } })}function main() { Java.perform(function () { hook(); })}setImmediate(main); åœ¨ Frida ä¸­ï¼š â€‹Memory æ˜¯ Frida çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œæä¾›äº†è®¿é—®ç›®æ ‡è¿›ç¨‹å†…å­˜çš„æ–¹æ³•ã€‚ å®ƒå¯ä»¥ç”¨æ¥ï¼š è¯»å–å†…å­˜ï¼ˆå¦‚ Memory.readUtf8String(ptr)ã€Memory.readByteArray(ptr, size)ï¼‰ å†™å…¥å†…å­˜ï¼ˆå¦‚ Memory.writeUtf8String(ptr, &quot;hello&quot;)ï¼‰ ä½ ç”¨çš„ Memory.readUtf8String() æ˜¯å®ƒæœ€å¸¸ç”¨çš„å‡½æ•°ä¹‹ä¸€ï¼Œä¸“é—¨å¤„ç† C å­—ç¬¦ä¸²ï¼ˆä»¥ null ç»“å°¾çš„ UTF-8 å­—ç¬¦ä¸²ï¼‰ã€‚ â€ 0x9 Hook Nativeå±‚å‡½æ•°çš„è¿”å›å€¼check_flagçš„å€¼å¦‚æœæ˜¯1337å°±æ‰“å°flag nativeå±‚ä¸­çš„è¯¥å‡½æ•°çš„è¿”å›å€¼æ˜¯1 ä¿®æ”¹è¯¥å‡½æ•°çš„è¿”å›å€¼å³å¯ 12345678910111213141516171819202122232425function hook() { var target = Module.enumerateExports(&quot;liba0x9.so&quot;)[0][&quot;address&quot;]; console.log(&quot;addr is :&quot;, target); Interceptor.attach(target, { onEnter: function (args) { }, onLeave: function (retval) { console.log(&quot;Origin retval is :&quot;, retval); retval.replace(1337); } })}function main() { Java.perform(function () { hook(); })}setImmediate(main); æ€è€ƒï¼š è¿™ä¸€å¥ 1var target = Module.enumerateExports(&quot;liba0x9.so&quot;)[0][&quot;address&quot;]; åœ¨ 0x8 ä¸­ä½¿ç”¨çš„æ˜¯ 1var target = Module.findExportByName(&quot;libc.so&quot;, &quot;strcmp&quot;); æˆ‘çš„çŒœæƒ³æ˜¯ï¼Œåœ¨ 0x8 ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Module.enumerateImports(â€œlibfrida0x8.soâ€)æŸ¥çœ‹å¯¼å…¥è¡¨ï¼Œè€Œåœ¨è¯¥é¢˜ç›®ä¸­ï¼Œç”±äºhookçš„æ˜¯è‡ªå·±çš„å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨Module.enumerateExports(â€œliba0x9.soâ€)æŸ¥çœ‹å¯¼å‡ºè¡¨ å¯¼å…¥è¡¨ï¼ˆImportsï¼‰ ï¼šæ˜¯è¿™ä¸ªåº“ è°ƒç”¨åˆ«äººçš„å‡½æ•°ï¼Œé€šå¸¸æ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œæ¯”å¦‚ libc.so é‡Œçš„ mallocã€printfã€strlen ç­‰ã€‚ å¯¼å‡ºè¡¨ï¼ˆExportsï¼‰ ï¼šæ˜¯è¿™ä¸ªåº“ æš´éœ²ç»™åˆ«äººç”¨çš„å‡½æ•°ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯ä½ è‡ªå·±å†™çš„ï¼Œæ¯”å¦‚ Java_com_example_myapp_NativeMethod è¿™ç§ native æ¥å£ï¼Œæˆ–è€…ä¸€äº›æ’ä»¶è°ƒç”¨çš„å…¥å£å‡½æ•°ã€‚ æŸ¥çœ‹å¯¼å‡ºè¡¨ å°è¯•æ”¹æˆè·Ÿ 0x8 ä¸­å·®ä¸å¤šçš„å†™æ³• 1var target = Module.findExportByName(&quot;liba0x9.so&quot;, &quot;Java_com_ad2001_a0x9_MainActivity_check_1flag&quot;); å¥½å§è¿™æ ·ä¹Ÿå¯ä»¥ï¼Œå®è·µå‡ºçœŸçŸ¥äº† è¿˜æ˜¯è§£é‡Šä¸€ä¸‹è¿™ä¸€å¥å§ 1var target = Module.enumerateExports(&quot;liba0x9.so&quot;)[0][&quot;address&quot;]; â€‹Module.enumerateExports(&quot;liba0x9.so&quot;)è¿™ä¼šåˆ—å‡º liba0x9.so è¿™ä¸ª native åº“é‡Œå¯¼å‡ºçš„æ‰€æœ‰å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯é‚£äº›å¯¹å¤–å¼€æ”¾å¯ä»¥è°ƒç”¨çš„å‡½æ•°ï¼‰ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«ä¿¡æ¯çš„æ•°ç»„ï¼Œæ¯”å¦‚ï¼š 12345[ {name: &quot;check_flag&quot;, address: ptr(&quot;0x12345678&quot;), type: &quot;function&quot;}, {name: &quot;init&quot;, address: ptr(&quot;0x12345690&quot;), type: &quot;function&quot;}, ...] â€‹[0][&quot;address&quot;]è¡¨ç¤ºå–è¿™ä¸ªå¯¼å‡ºå‡½æ•°åˆ—è¡¨é‡Œçš„ç¬¬ä¸€ä¸ªå‡½æ•°çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ check_flag çš„åœ°å€ï¼ˆå‡è®¾ç¬¬ä¸€ä¸ªåˆšå¥½æ˜¯å®ƒï¼‰ã€‚è¿™ä¸€è¡ŒæŠŠè¿™ä¸ªåœ°å€èµ‹å€¼ç»™ check_flag å˜é‡ã€‚[0]è¡¨ç¤ºç´¢å¼• â€ 0xA Hook Nativeå±‚æœªè¢«è°ƒç”¨çš„æ–¹æ³•ä»æœ¬ç« å¼€å§‹ä½¿ç”¨æ¨¡æ‹Ÿå™¨ä¼šé—ªé€€ï¼Œè¿™é‡Œä½¿ç”¨çš„ç¯å¢ƒæ˜¯Redmi K60 å®‰å“14 å·²ROOT å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ¨¡æ¿ 123var native_adr = new NativePointer(&lt;address_of_the_native_function&gt;);const native_function = new NativeFunction(native_adr, '&lt;return type&gt;', ['argument_data_type']);native_function(&lt;arguments&gt;); â€ è®©æˆ‘ä»¬æ¥é€è¡Œè§£é‡Šä¸€ä¸‹ 1var native_adr = new NativePointer(&lt;address_of_the_native_function&gt;); è¿™ä¸€å¥çš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªåŸç”Ÿå‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼ˆæ¯”å¦‚ 0x12345678ï¼‰ï¼ŒæŠŠå®ƒå°è£…æˆä¸€ä¸ª NativePointer ç±»å‹çš„å¯¹è±¡ï¼Œå¥½è®© Frida èƒ½è¯†åˆ«è¿™ä¸ªåœ°å€ã€‚&lt;address_of_the_native_function&gt; æ˜¯æ‰‹åŠ¨å¡«è¿›å»çš„åœ°å€ï¼Œé€šå¸¸æ˜¯é€šè¿‡é€†å‘åˆ†æï¼ˆIDAã€Frida hook ç­‰ï¼‰æ‰¾åˆ°çš„å‡½æ•°åœ°å€ã€‚ â€ 1const native_function = new NativeFunction(native_adr, '&lt;return type&gt;', ['argument_data_type']); è¿™ä¸€è¡Œçš„æ„æ€æ˜¯ï¼ŒæŠŠè¿™ä¸ªåœ°å€ï¼ˆnative_adrï¼‰å¯¹åº”çš„å‡½æ•°è½¬æ¢æˆ JavaScript èƒ½è°ƒç”¨çš„å‡½æ•°ã€‚ â€‹&lt;return type&gt; è¡¨ç¤ºè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œæ¯”å¦‚ 'int'ã€'void'ã€'pointer' ç­‰ã€‚ â€‹['argument_data_type'] è¡¨ç¤ºè¿™ä¸ªå‡½æ•°çš„å‚æ•°ç±»å‹åˆ—è¡¨ï¼Œæ¯”å¦‚ ['int', 'pointer']ã€‚ æ‰€ä»¥è¿™ä¸€è¡Œçš„ä½œç”¨æ˜¯ï¼šç”¨ Frida çš„ â€‹NativeFunctionâ€‹ åŒ…è£…åŸç”Ÿå‡½æ•°ï¼Œè®©ä½ å¯ä»¥åƒæ™®é€š JS å‡½æ•°é‚£æ ·å»è°ƒç”¨å®ƒã€‚ â€ 1native_function(&lt;arguments&gt;); æœ€åç›´æ¥è°ƒç”¨è¿™ä¸ªåŸç”Ÿå‡½æ•°ï¼Œä¼ å…¥ä½ éœ€è¦çš„å‚æ•°ï¼ˆè¿™äº›å‚æ•°è¦å’Œä¸Šé¢å£°æ˜çš„å‚æ•°ç±»å‹åŒ¹é…ï¼‰ ç°åœ¨æ¥çœ‹çœ‹ä¾‹é¢˜ Javaå±‚å¹¶ä¸èƒ½çœ‹åˆ°ä»€ä¹ˆæœ‰ç”¨çš„ï¼Œåªæ˜¯åŠ è½½äº†stringFromJNI()â€‹ æˆ‘ä»¬æ¥çœ‹çœ‹nativeå±‚ï¼ŒstringFromJNIä¹Ÿæ²¡ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªget_flagå‡½æ•°å¯ä»¥æ‰“å°flag äºæ˜¯æ€è·¯å°±æ˜¯ï¼Œåˆ©ç”¨ä¸Šé¢çš„æ¨¡æ¿ hook å‡ºget_flagå‡½æ•° æ¨¡ä»¿ 0x9 ä¸­ä½¿ç”¨ Module.enumerateExports(â€œlibfrida0xa.soâ€) æŸ¥çœ‹å¯¼å‡ºè¡¨ï¼Œå‘ç°å¯¼å‡ºè¡¨éå¸¸ä¹‹é•¿ï¼Œç›´æ¥ä½¿ç”¨var target = Module.enumerateExports(â€œliba0x9.soâ€)[0][â€œaddressâ€];è¿›è¡Œç´¢å¼•ä¼šæœ‰ç‚¹éº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³• ç”±äºALSRï¼ˆåœ°å€éšæœºåŒ–ï¼‰çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä½¿ç”¨Module.findBaseAddress(&quot;libfrida0xa.so&quot;);æŸ¥çœ‹ä¸€ä¸‹åŸºåœ°å€ å¯ä»¥æ„é€ å¦‚ä¸‹å¾ªç¯ 1234567891011121314151617var base_addr = Module.findBaseAddress(&quot;libfrida0xa.so&quot;); var exports = Module.enumerateExports(&quot;libfrida0xa.so&quot;); var target = null;for (var i = 0; exports[i] != null; i++){ if (exports[i][&quot;name&quot;] == &quot;_Z8get_flagii&quot;) { console.log(&quot;function get_flag : &quot;, exports[i][&quot;address&quot;]); console.log((exports[i][&quot;address&quot;] - base_addr).toString(16)); target = exports[i][&quot;address&quot;]; } } è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°åŸºåœ°å€åï¼Œéå†å¯¼å‡ºè¡¨ï¼Œå¦‚æœåœ¨å¯¼å‡ºè¡¨ä¸­æ‰¾åˆ°äº† get_flag å‡½æ•°ï¼Œå°±æ‰“å°å‡º get_flag å‡½æ•°çš„ç»å¯¹åœ°å€ åŒæ—¶ç”±äºæˆ‘ä»¬çŸ¥é“äº†ç»å¯¹åœ°å€å’ŒåŸºåœ°å€ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¯ä»¥é¡ºä¾¿æŠŠåç§»åœ°å€ä¹Ÿæ‰“å°å‡ºæ¥ åç§» = å‡½æ•°åœ°å€ - æ¨¡å—åŸºåœ°å€ è¿™æ ·æˆ‘ä»¬å°±æ‰¾åˆ°äº†æˆ‘ä»¬éœ€è¦ hook çš„ç›®æ ‡å‡½æ•°çš„åœ°å€ â€ è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆ get_flag è¦å†™æˆ â€œ_Z8get_flagiiâ€ å‘¢ è¿™å…¶å®æ˜¯C++ çš„ name manglingï¼ˆåå­—æ”¹ç¼– / åå­—é‡æ•´ï¼‰é—®é¢˜ ä»€ä¹ˆæ˜¯ Name Manglingï¼Ÿ åœ¨ C++ ä¸­ï¼Œå‡½æ•°åä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨æ”¹å†™æˆä¸€ä¸²å¸¦æœ‰é¢å¤–ä¿¡æ¯çš„åå­—ï¼Œç§°ä¸º mangled nameï¼ˆé‡æ•´åå­—ï¼‰ ã€‚ è¿™æ˜¯å› ä¸º C++ æ”¯æŒå‡½æ•°é‡è½½ï¼ˆåŒåå‡½æ•°ï¼Œä¸åŒå‚æ•°ï¼‰ ï¼Œè€Œæ±‡ç¼–è¯­è¨€ã€é“¾æ¥å™¨ã€æ“ä½œç³»ç»Ÿç­‰åº•å±‚ä¸œè¥¿å¹¶ä¸æ”¯æŒè¿™ä¸€ç‰¹æ€§ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 12int add(int a, int b);float add(float a, float b); è¿™ä¸¤ä¸ªå‡½æ•°åœ¨ C++ ä¸­æ˜¯åˆæ³•çš„ï¼Œå› ä¸ºå®ƒä»¬å‚æ•°ä¸åŒã€‚ä½†å¦‚æœä½ ä¸åš name manglingï¼Œå®ƒä»¬åœ¨æ±‡ç¼–/ç¬¦å·è¡¨é‡Œéƒ½å« addï¼Œç³»ç»Ÿå°±ä¸çŸ¥é“ä½ åˆ°åº•æƒ³è°ƒç”¨å“ªä¸ªã€‚ æ‰€ä»¥ç¼–è¯‘å™¨ä¼šæŠŠå®ƒä»¬æ”¹åï¼š 12int add(int, int) --&gt; _Z3addiifloat add(float, float) --&gt; _Z3addff è¿™å°±æ˜¯ name manglingã€‚ ç”±äºæˆ‘ä»¬ä¸»è¦ç ”ç©¶frida hookï¼Œè¿™ä¸ªé—®é¢˜å°±ä¸è¿‡å¤šèµ˜è¿° â€ å›å½’æ­£é¢˜ï¼ŒçŸ¥é“äº†æˆ‘ä»¬çš„ç›®æ ‡åœ°å€åå°±å¯ä»¥ç›´æ¥å†™è„šæœ¬å•¦ï¼Œåˆ©ç”¨ä¸Šé¢çš„æ¨¡æ¿ 12345678910111213141516171819202122232425262728293031323334353637function hook() { var base_addr = Module.findBaseAddress(&quot;libfrida0xa.so&quot;); var exports = Module.enumerateExports(&quot;libfrida0xa.so&quot;); var target = null; for (var i = 0; exports[i] != null; i++){ if (exports[i][&quot;name&quot;] == &quot;_Z8get_flagii&quot;) { console.log(&quot;function get_flag : &quot;, exports[i][&quot;address&quot;]); console.log(&quot;base addr is:&quot;, (exports[i][&quot;address&quot;] - base_addr).toString(16)); target = exports[i][&quot;address&quot;]; } } var get_flag_ptr = new NativePointer(target); const My_get_flag = new NativeFunction(get_flag_ptr, 'char', ['int', 'int']); var flag = My_get_flag(1, 2); console.log(flag);}function main() { Java.perform(function () { hook(); })}setImmediate(main) ç”±äºæ‰“å°å‡ºçš„æ˜¯å‡½æ•°çš„è¿”å›å€¼ï¼Œè€Œä¸”soæ–‡ä»¶ä¸­ä½¿ç”¨çš„å‡½æ•°æ˜¯__android_log_printï¼Œæ‰€ä»¥flagåœ¨logcatä¸­å¯ä»¥çœ‹åˆ° æ€è€ƒï¼šèƒ½å¦ç›´æ¥åœ¨fridaé¢æ¿ä¸­æ‰“å°å‡ºflagï¼Ÿ æœ‰çš„å…„å¼Ÿï¼Œæœ‰çš„ è¿˜è®°å¾—lab0x8çš„å†…å®¹å—ï¼Œæˆ‘ä»¬å¯ä»¥Hook __android_log_printè¿™ä¸ªå‡½æ•°ï¼Œç›´æ¥æˆªè· flag flagçš„å†…å®¹æ˜¯__android_log_printçš„ç¬¬å››ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è¯»å–å®ƒçš„ç¬¬å››ä¸ªå‚æ•°ç„¶åæ‰“å°å‡ºæ¥å°±è¡Œ å®Œæ•´hookå¹¶æ‰“å°flagçš„è„šæœ¬å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051function hook() { var base_addr = Module.findBaseAddress(&quot;libfrida0xa.so&quot;); var exports = Module.enumerateExports(&quot;libfrida0xa.so&quot;); var target = null; for (var i = 0; exports[i] != null; i++){ if (exports[i][&quot;name&quot;] == &quot;_Z8get_flagii&quot;) { console.log(&quot;function get_flag : &quot;, exports[i][&quot;address&quot;]); console.log(&quot;base addr is:&quot;, (exports[i][&quot;address&quot;] - base_addr).toString(16)); target = exports[i][&quot;address&quot;]; } } var get_flag_ptr = new NativePointer(target); const My_get_flag = new NativeFunction(get_flag_ptr, 'char', ['int', 'int']); var print_addr = Module.findExportByName(null, &quot;__android_log_print&quot;); //hook __android_log_printå‡½æ•° Interceptor.attach(print_addr, { onEnter: function (args) { var flagPtr = args[3]; var flag = flagPtr.readCString(); console.log(flag); //è¯»å–å¹¶æ‰“å°flagå†…å®¹ }, onLeave: function (retval) { } }); var flag = My_get_flag(1, 2); console.log(flag);}function main() { Java.perform(function () { hook(); })}setImmediate(main) â€ 0xB æ›´æ”¹Nativeå±‚çš„æ±‡ç¼–æŒ‡ä»¤å…ˆæ¥çœ‹x86ä¸‹çš„æ¨¡æ¿ 12345678910var writer = new X86Writer(opcodeaddr);Memory.protect(opcodeaddr, 0x1000, &quot;rwx&quot;);try { writer.flush(); } finally { writer.dispose();} æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹ 1var writer = new X86Writer(opcodeaddr); åˆ›å»ºäº†ä¸€ä¸ªå†™æŒ‡ä»¤çš„â€œå†™æ‰‹â€å¯¹è±¡ï¼Œå« writerã€‚ â€‹X86Writer æ˜¯ Frida æä¾›çš„ä¸€ä¸ªç±»ï¼Œç”¨æ¥å‘æŒ‡å®šå†…å­˜åœ°å€å†™å…¥ x86 æ±‡ç¼–æŒ‡ä»¤ã€‚ â€‹opcodeaddr æ˜¯ä½ æƒ³ä¿®æ”¹çš„åœ°å€ï¼Œæ¯”å¦‚æŸä¸ªå‡½æ•°å¼€å¤´æˆ–è€…ä¸­é—´çš„æŒ‡ä»¤åœ°å€ã€‚ 1emory.protect(opcodeaddr, 0x1000, &quot;rwx&quot;); æŠŠä» opcodeaddr å¼€å§‹çš„ä¸€æ®µå†…å­˜ï¼ˆå¤§å°ä¸º 0x1000 å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ä¸€é¡µï¼‰è®¾ç½®ä¸ºå¯è¯»ï¼ˆrï¼‰ã€å¯å†™ï¼ˆwï¼‰ã€å¯æ‰§è¡Œï¼ˆxï¼‰ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç¨‹åºçš„ä»£ç åŒºåŸŸä¸€èˆ¬æ˜¯åªè¯»çš„ï¼›è¦æƒ³ä¿®æ”¹å®ƒï¼Œå°±å¾—å…ˆæŠŠå®ƒâ€œè§£é”â€ã€‚ 1try { writer.flush(); } tryå—ä¸­æˆ‘ä»¬å¯ä»¥æ’å…¥è¦ä¿®æ”¹/æ·»åŠ çš„x86æŒ‡ä»¤ã€‚X86Writerå®ä¾‹æä¾›äº†å„ç§æ–¹æ³•æ¥æ’å…¥å„ç§x86æŒ‡ä»¤ã€‚ â€‹writer.flush();â€‹ æ’å…¥æŒ‡ä»¤åï¼Œè°ƒç”¨flushæ–¹æ³•å°†æ›´æ”¹åº”ç”¨åˆ°å†…å­˜ä¸­ã€‚è¿™ç¡®ä¿ä¿®æ”¹åçš„æŒ‡ä»¤è¢«å†™å…¥å†…å­˜ä½ç½®ã€‚ 1finally { writer.dispose(); } æœ€åæ— è®ºæ˜¯å¦å‡ºé”™ï¼Œéƒ½è°ƒç”¨ dispose() æ¥é‡Šæ”¾èµ„æºã€‚å¦åˆ™å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ å¯¹äºx86è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥é˜…å¦‚ä¸‹æ–‡æ¡£ JavaScript API | Frida â€¢ A world-class dynamic instrumentation toolkit å¯¹äºarm64è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥é˜…å¦‚ä¸‹æ–‡æ¡£ JavaScript API | Frida â€¢ A world-class dynamic instrumentation toolkit æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹ä¾‹é¢˜ï¼Œä½¿ç”¨çš„æ¶æ„ä¸ºarm64æ¶æ„ Javaå±‚ä¾æ—§æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰ nativeå±‚ä¸­çš„MainActivityä¼ªä»£ç ç•Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸æ­£å¸¸ çœ‹çœ‹æ§åˆ¶æµï¼Œå‘ç°è¿™é‡Œæ„æˆäº†ä¸€ä¸ªæ°¸å‡è·³è½¬æŒ‡ä»¤ï¼Œå¯¼è‡´æˆ‘ä»¬çš„IDAåç¼–è¯‘å‡ºé”™ é‚£ä¹ˆï¼Œæˆ‘ä»¬ç›´æ¥nopæ‰è¿™ä¸ªB.NEå³å¯ IDAæŸ¥çœ‹åç§»åœ°å€æ˜¯åœ¨0x15248å¤„ å¼€å§‹hook 123456789101112131415161718192021222324252627function hook() { var base_addr = Module.getBaseAddress(&quot;libfrida0xb.so&quot;); console.log(&quot;Base address : &quot;, base_addr); var BNE_addr = base_addr.add(0x15248); Memory.protect(base_addr, 0x1000, &quot;rwx&quot;); var writer = new Arm64Writer(BNE_addr); try { writer.putNop(); writer.flush(); console.log(&quot;Success!!&quot;); } finally { writer.dispose(); }}function main() { Java.perform(function () { hook(); })}setTimeout(main, 1000); åŒæ ·æ˜¯éœ€è¦åˆ°logcatä¸­æŸ¥çœ‹flag â€ â€ â€ â€ â€ â€ â€ â€ â€ â€ â€ â€","link":"/2024/04/10/Frida%20labs/"}],"tags":[{"name":"æ¯”èµ›å¤ç°","slug":"æ¯”èµ›å¤ç°","link":"/tags/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/"},{"name":"å®‹è¯","slug":"å®‹è¯","link":"/tags/%E5%AE%8B%E8%AF%8D/"},{"name":"å¤ä»£æ•£æ–‡","slug":"å¤ä»£æ•£æ–‡","link":"/tags/%E5%8F%A4%E4%BB%A3%E6%95%A3%E6%96%87/"},{"name":"ç§»åŠ¨å®‰å…¨","slug":"ç§»åŠ¨å®‰å…¨","link":"/tags/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/"}],"categories":[{"name":"é€†å‘","slug":"é€†å‘","link":"/categories/%E9%80%86%E5%90%91/"},{"name":"å¤æ–‡","slug":"å¤æ–‡","link":"/categories/%E5%8F%A4%E6%96%87/"}]}
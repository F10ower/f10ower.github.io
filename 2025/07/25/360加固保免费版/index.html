<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Yourname"><title>360加固保免费版分析 · 临江仙的花间阁</title><meta name="description" content="分析360加固保免费版，学习逆向技术（此篇未完结）


使用360加固保免费版加固，注意加固时要把签名校验给去除，因为加固之后的app是没有签名的，自己签名之后如果有签名校验，程序可能会闪退
‍
Java层分析这是我自己写的一个app，可以看到没有加固时可以直接看到MainActivity

加固之"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"><img src="/images/logo.webp"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:220px;" alt="favicon"><h3 title=""><a href="/">临江仙的花间阁</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/Lhcfl"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Yourname</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>360加固保免费版分析</a></h3></div><div class="post-content"><p><p>分析360加固保免费版，学习逆向技术（此篇未完结）</p>
<span id="more"></span>

<p>使用360加固保免费版加固，注意加固时要把签名校验给去除，因为加固之后的app是没有签名的，自己签名之后如果有签名校验，程序可能会闪退</p>
<p>‍</p>
<h2 id="Java层分析"><a href="#Java层分析" class="headerlink" title="Java层分析"></a>Java层分析</h2><p>这是我自己写的一个app，可以看到没有加固时可以直接看到MainActivity</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709153602-4evta90.png" alt="image"></p>
<p>加固之后MainActivity字样没了，出现了StubAPP类和tianyu.util字样，可以知道这就是该加固的特征</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709153635-jfl8eqm.png" alt="image"></p>
<p>StubApp类里面使用a方法传递了一串字符串，跟进a方法，注意a有多个重载方法，需要查看具有一个字符串参数的重载方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709153810-asonqbd.png" alt="image"></p>
<p>发现就是对字符串进行一个解混淆，方式为异或16，这里可以用Cyberchef先解一下看看</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709153944-uz9a4kn.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709154014-t5t5958.png" alt="image"></p>
<p>使用Frida hook看看这个方法做了些什么，直接在jadx里选择复制为frida片段</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709154239-eelvct9.png" alt="image"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook</span>(<span class="hljs-params"></span>) &#123;<br><br><br>    <span class="hljs-keyword">let</span> a = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.tianyu.util.a&quot;</span>);<br>    a[<span class="hljs-string">&quot;a&quot;</span>].<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">str</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`a.a is called: str=<span class="hljs-subst">$&#123;str&#125;</span>`</span>);<br>        <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;a&quot;</span>](str);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`a.a result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;;<br><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">hook</span>();<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到就是加载了一些Android系统内部类或方法名</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709154306-w7jr6xk.png" alt="image"></p>
<p>继续观察StubApp类，看见下面会根据设备的架构来加载不同的so文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709155119-s00uw2u.png" alt="image"></p>
<p>再与正常未加固的apk对比一下，发现加固之后的apk多了一个assets文件夹，里面存着一些so文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709155941-sxtt2uw.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709155958-xxqst5f.png" alt="image"></p>
<p>不难分析出，该加固是在Native层来释放dex文件</p>
<p>‍</p>
<h2 id="Native层分析"><a href="#Native层分析" class="headerlink" title="Native层分析"></a>Native层分析</h2><p>分析so文件，发现导入导出表被抹除得一干二净</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709160226-czuhur7.png" alt="image"></p>
<p>如果没有导入导出表的话，elf文件应该是使用了自定义的动态链接器来进行链接的，所以，只要再elf文件被装载进内存之后将它dump下来，应该就能恢复符号表了</p>
<p>在Linux系统中，dlopen函数用于动态链接库加载函数，它存在于<code>libdl.so</code>库中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// 1. 加载库</span><br><span class="hljs-type">void</span>* libHandle = dlopen(<span class="hljs-string">&quot;/data/data/pkg/libnative.so&quot;</span>, RTLD_NOW);<br><span class="hljs-keyword">if</span> (!libHandle) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error: %s\n&quot;</span>, dlerror());<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">// 2. 获取函数指针</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">int</span> <span class="hljs-params">(*NativeFunc)</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br>NativeFunc func = (NativeFunc)dlsym(libHandle, <span class="hljs-string">&quot;native_add&quot;</span>);<br><span class="hljs-keyword">if</span> (!func) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error: %s\n&quot;</span>, dlerror());<br>    dlclose(libHandle);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">// 3. 调用函数</span><br><span class="hljs-type">int</span> result = func(<span class="hljs-number">42</span>);<br><br><span class="hljs-comment">// 4. 卸载库</span><br>dlclose(libHandle);<br></code></pre></td></tr></table></figure>

<p>在安卓7.0之后，则需要hook的是android_dlopen_ext函数</p>
<p>frida hook一下看看它加载了哪些函数</p>
<p>android_dlopen_ext() 的格式为<code>android_dlopen_ext(&quot;/data/data/pkg/libsecret.so&quot;, RTLD_NOW, NULL);</code>，所以我们需要获取第一个参数的值来得到它链接了哪些so文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C">function <span class="hljs-title function_">hook</span><span class="hljs-params">()</span> &#123;<br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libdl.so&quot;</span>, <span class="hljs-string">&quot;android_dlopen_ext&quot;</span>), &#123;<br>        onEnter: function (args) &#123;<br>            <span class="hljs-comment">// console.log(&#x27;Entering &#x27; + functionName);</span><br>            <span class="hljs-comment">// Modify or log arguments if needed</span><br>            console.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;load -&gt; &quot;</span>, args[<span class="hljs-number">0</span>].readCString());<br>        &#125;,<br>        onLeave: function (retval) &#123;<br>            <span class="hljs-comment">// console.log(&#x27;Leaving &#x27; + functionName);</span><br>            <span class="hljs-comment">// Modify or log return value if needed</span><br>        &#125;<br>    &#125;);<br>&#125;<br><br>function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br>    Java.perform(function () &#123;<br>        hook();<br>    &#125;)<br>&#125;<br><br>setImmediate(main);<br></code></pre></td></tr></table></figure>

<p>正如所料，它链接了这个so文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709163334-dxuld2c.png" alt="image"></p>
<p>接下来在它将该so文件装载到内存之后dump下来，就可以得到带有导入导出表的so文件了</p>
<p>（dump脚本来自SWDD）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">dump_so</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> soName = <span class="hljs-string">&quot;libjiagu_64.so&quot;</span>;<br>    <span class="hljs-keyword">var</span> libSo = <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">getModuleByName</span>(soName);<br>    <span class="hljs-keyword">var</span> save_path = <span class="hljs-string">&quot;/data/data/com.example.nativetest/&quot;</span> + libSo.<span class="hljs-property">name</span> + <span class="hljs-string">&quot;_Dump&quot;</span>;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[Base]-&gt;&quot;</span>, libSo.<span class="hljs-property">base</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[Size]-&gt;&quot;</span>, <span class="hljs-title function_">ptr</span>(libSo.<span class="hljs-property">size</span>));<br>    <span class="hljs-keyword">var</span> handle = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(save_path, <span class="hljs-string">&quot;wb&quot;</span>);<br>    <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">protect</span>(<span class="hljs-title function_">ptr</span>(libSo.<span class="hljs-property">base</span>), libSo.<span class="hljs-property">size</span>, <span class="hljs-string">&#x27;rwx&#x27;</span>);<br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">Buffer</span> = libSo.<span class="hljs-property">base</span>.<span class="hljs-title function_">readByteArray</span>(libSo.<span class="hljs-property">size</span>);<br>    handle.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">Buffer</span>);<br>    handle.<span class="hljs-title function_">flush</span>();<br>    handle.<span class="hljs-title function_">close</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[DumpPath-&gt;]&quot;</span>, save_path);<br><br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(dump_so);<br></code></pre></td></tr></table></figure>

<p>注意，要在app运行之后再把脚本附加上去，否则如果还没来得及链接就dump的话，frida会直接报错</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709163731-zkjq895.png" alt="image"></p>
<p>所以这里使用命令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">frida -U <span class="hljs-string">&#x27;NativeTest&#x27;</span> -l dump_so.<span class="hljs-property">js</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709163808-0cfeau3.png" alt="image"></p>
<p>成功dump，并且得到了文件的基地址和大小</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709163918-56u3gz5.png" alt="image"></p>
<p>成功恢复</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709164129-v3p5sc3.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709164143-2l9gqse.png" alt="image"></p>
<p>‍</p>
<h2 id="壳文件分析"><a href="#壳文件分析" class="headerlink" title="壳文件分析"></a>壳文件分析</h2><p>这里有一个知识点</p>
<blockquote>
<h3 id="加固壳的典型行为模式"><a href="#加固壳的典型行为模式" class="headerlink" title="加固壳的典型行为模式"></a><strong>加固壳的典型行为模式</strong></h3><p>加固壳的核心任务是 <strong>保护原始代码</strong>，其常见流程包括：</p>
<ol>
<li><p><strong>解密资源</strong>：</p>
<ul>
<li>原始 APK&#x2F;Dex&#x2F;So 文件被加密，隐藏在 <code>assets</code>、<code>lib/</code> 或自定义目录中。</li>
<li>运行时，壳代码需要先 <strong>读取这些加密文件</strong>（通过 <code>open</code> + <code>read</code>）。</li>
</ul>
</li>
<li><p><strong>动态加载</strong>：</p>
<ul>
<li>解密后的文件（如 Dex、So）会通过 <code>dlopen</code>、<code>mmap</code> 或 <code>DexClassLoader</code> 加载到内存。</li>
</ul>
</li>
<li><p><strong>内存执行</strong>：</p>
<ul>
<li>解密后的代码在内存中执行，避免留下完整的磁盘文件。</li>
</ul>
</li>
</ol>
<p><strong>关键点</strong>：<br>➜ <strong>加固壳必须读取加密文件</strong> → 必然调用 <code>open</code> 函数 → <strong>Hook</strong> <strong>​<code>open</code>​</strong> <strong>可以捕获文件访问路径</strong>。</p>
</blockquote>
<p>思路就是 hook open函数来看看它有没有读取什么东西</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-keyword">var</span> openPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-comment">// var openAdrr = new NativePointer(openPtr);</span><br>    <span class="hljs-keyword">const</span> open = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);<br><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(openPtr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">fileNamePtr, flag</span>) &#123;<br>        <br>        <span class="hljs-keyword">var</span> fileName = fileNamePtr.<span class="hljs-title function_">readCString</span>();<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[open : ]&quot;</span>, fileName);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">open</span>(fileNamePtr, flag);<br>    &#125; , <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]))<br><br><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">hook</span>();<br>    &#125;)<br>&#125;<br><br><span class="hljs-comment">// setTimeout(main, 1000);</span><br><span class="hljs-title function_">setImmediate</span>(main);<br></code></pre></td></tr></table></figure>

<p>注意这里一定要new一个NativeCallback</p>
<p>在 Frida 中，<code>NativeCallback</code> 的作用是 <strong>创建一个符合原生代码调用约定的 JavaScript 回调函数</strong>，用于替换或拦截原生函数（如 <code>open</code>）</p>
<p>原生代码（如 C 的 <code>open</code> 函数）有严格的 <strong>参数传递规则</strong>（如寄存器&#x2F;栈传参、类型转换），而 JavaScript 是弱类型语言，无法直接匹配</p>
<p>不然的话会出现如下报错</p>
<p><code>fileNamePtr</code> 可能未被正确识别为 <code>pointer</code> 类型</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709215005-d6hgc81.png" alt="image"></p>
<p>可以看到打开了如下文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/image-20250709215238-5ec1xgp.png" alt="image"></p>
<p>发现个很可疑的点，它频繁访问了 &#x2F;proc&#x2F;self&#x2F;maps</p>
<blockquote>
<h3 id="​-proc-self-maps​-的作用"><a href="#​-proc-self-maps​-的作用" class="headerlink" title="​/proc/self/maps​ 的作用"></a><strong>​<code>/proc/self/maps</code>​</strong> <strong>的作用</strong></h3><ul>
<li><p><strong>功能</strong>：该文件实时显示当前进程的内存映射布局，包括：</p>
<ul>
<li>加载的模块（<code>.so</code>&#x2F;<code>.dex</code>）基地址和大小</li>
<li>内存权限（可读&#x2F;可写&#x2F;可执行）</li>
<li>文件来源路径</li>
</ul>
</li>
<li><p><strong>典型访问场景</strong>：</p>
<ul>
<li><strong>加固壳</strong>：检测内存是否被篡改（反调试）。</li>
<li><strong>动态加载库</strong>：定位空闲内存区域加载新代码。</li>
<li><strong>内存扫描</strong>：查找敏感数据或函数地址。</li>
</ul>
</li>
</ul>
</blockquote>
<p>这里反复读取maps猜测是为了混淆视听，当加载dex时，maps上的内存映射会发生变化，留下记录，比如 &#x2F;data&#x2F;app&#x2F;xxx&#x2F;base.dex，这时候壳文件就通过反复读取maps来隐藏打开dex的操作，掩盖真正的 Dex 加载时机</p>
<p>此时，如果我们自定义一个fakeMaps，将壳文件对maps的操作重定向到我们的fakeMaps上，就可以很方便地观察壳文件加载dex的操作了，同时也能避免壳的反检测机制（如果有的话）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-keyword">var</span> openPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-comment">// var openAdrr = new NativePointer(openPtr);</span><br>    <span class="hljs-keyword">const</span> open = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);<br><br>    <span class="hljs-keyword">var</span> fakeMaps = <span class="hljs-string">&quot;/data/data/com.example.nativetest/maps&quot;</span><br><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(openPtr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">fileNamePtr, flag</span>) &#123;<br><br>        <span class="hljs-keyword">var</span> fileName = fileNamePtr.<span class="hljs-title function_">readCString</span>();<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[open : ]&quot;</span>, fileName);<br><br>        <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">FD</span> = <span class="hljs-title function_">open</span>(fileNamePtr, flag); <span class="hljs-comment">//调用原始open函数，记录原始open函数的文件描述符</span><br><br>        <span class="hljs-keyword">if</span> (fileName.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;maps&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">//如果文件名包含maps，将其重定向到fakeMaps上</span><br>            <br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;sucess find maps&quot;</span>);<br><br>            <span class="hljs-keyword">var</span> fakeMapsAddr = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(fakeMaps);<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_">open</span>(fakeMapsAddr, flag); <span class="hljs-comment">// 打开伪造的maps文件，并返回其文件描述符（FD），而非真实的maps</span><br>            <br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fileName.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;dex&quot;</span> != -<span class="hljs-number">1</span>)) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&quot;open dex :&quot;</span>, fileName);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">FD</span>; <span class="hljs-comment">//返回原始FD使app正常运行</span><br>        <span class="hljs-comment">// return open(fileNamePtr, flag);</span><br>    &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]))<br><br><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">hook</span>();<br>    &#125;)<br>&#125;<br><br><span class="hljs-comment">// setTimeout(main, 1000);</span><br><span class="hljs-title function_">setImmediate</span>(main);<br><br></code></pre></td></tr></table></figure>

<p>可以发现确实是通过open去打开了dex文件，而且通过反复读取了maps来隐藏操作，验证了我们之前的猜想</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715203358.png" alt="image"></p>
<p>使用来查看dex的内存地址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;dex called from:\n&#x27;</span> + <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">FUZZY</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-keyword">var</span> openPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-comment">// var openAdrr = new NativePointer(openPtr);</span><br>    <span class="hljs-keyword">const</span> open = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);<br>    <span class="hljs-keyword">var</span> fakeMaps = <span class="hljs-string">&quot;/data/data/com.example.nativetest/maps&quot;</span>;<br><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(openPtr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">fileNamePtr, flag</span>) &#123;<br><br>        <span class="hljs-keyword">var</span> fileName = fileNamePtr.<span class="hljs-title function_">readCString</span>();<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[open : ]&quot;</span>, fileName);<br>        <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">FD</span> = <span class="hljs-title function_">open</span>(fileNamePtr, flag); <span class="hljs-comment">//调用原始open函数，记录原始open函数的文件描述符</span><br><br>        <span class="hljs-keyword">if</span> (fileName.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;maps&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">//如果文件名包含maps，将其重定向到fakeMaps上</span><br>            <br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;sucess find maps&quot;</span>);<br>            <span class="hljs-keyword">var</span> fakeMapsAddr = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(fakeMaps);<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_">open</span>(fakeMapsAddr, flag); <span class="hljs-comment">// 打开伪造的maps文件，并返回其文件描述符（FD），而非真实的maps</span><br>            <br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fileName.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;dex&quot;</span>) != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&quot;open dex :&quot;</span>, fileName);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;dex called from:\n&#x27;</span> + <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">FUZZY</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>            <br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">FD</span>; <span class="hljs-comment">//返回原始FD使app正常运行</span><br>        <span class="hljs-comment">// return open(fileNamePtr, flag);</span><br>    &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]))<br><br><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">hook</span>();<br>    &#125;)<br>&#125;<br><br><span class="hljs-comment">// setTimeout(main, 1000);+</span><br><span class="hljs-title function_">setImmediate</span>(main);<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715205613.png" alt="image"></p>
<p>可以发现打开dex的地址基本一模一样，在IDA中查看这个地址</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715205949.png" alt="image"></p>
<p>嘶，啥也没有，这不对吧</p>
<p>查阅多方资料，发现我漏了一步，在先前dump so文件的时候，so文件可能会有损坏，所以先需要修复一下so文件</p>
<p>使用soFixer</p>
<p><a target="_blank" rel="noopener" href="https://github.com/F8LEFT/SoFixer">soFixer</a>   0x0x7fff56d99000是之前dump so文件的时候输出的基地址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">.\<span class="hljs-title class_">SoFixer</span>-<span class="hljs-title class_">Windows</span>-<span class="hljs-number">64.</span>exe -s .\libjiagu_64.<span class="hljs-property">so_Dump</span> -o .\libjiagu_64.<span class="hljs-property">so_Fix</span> -m <span class="hljs-number">0x7fff56d99000</span> -d<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715210744.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715210721.png" alt="image"></p>
<p>使用sofix之后IDA将其识别成了ARM架构，但是我原本的文件是x86_64架构，这里要重新选择一下</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715211520.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715211720.png" alt="image"></p>
<p>这下就没问题了</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715212218.png" alt="image"></p>
<p>但是这段数据全是未定义的，这个时候就手足无措了</p>
<p>一通乱翻，发现了这样一个函数</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715220229.png" alt="image"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">char</span> __fastcall __arm_a_2(<span class="hljs-type">char</span> *a1, <span class="hljs-type">unsigned</span> __int64 a2, <span class="hljs-type">char</span> *a3, <span class="hljs-type">int</span> *a4, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a5)<br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// rax</span><br>  __int64 *v6; <span class="hljs-comment">// rsi</span><br>  __int64 v7; <span class="hljs-comment">// rbx</span><br>  __int64 *v8; <span class="hljs-comment">// rdi</span><br>  __int64 v9; <span class="hljs-comment">// rax</span><br>  _QWORD *v10; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">char</span> v12[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+90h] [rbp-168h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v13; <span class="hljs-comment">// [rsp+98h] [rbp-160h]</span><br>  __int64 v14; <span class="hljs-comment">// [rsp+A0h] [rbp-158h]</span><br>  __int64 v15[<span class="hljs-number">7</span>]; <span class="hljs-comment">// [rsp+B0h] [rbp-148h] BYREF</span><br>  _QWORD v16[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [rsp+E8h] [rbp-110h] BYREF</span><br>  __int128 v17; <span class="hljs-comment">// [rsp+F8h] [rbp-100h]</span><br>  __int128 v18[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+108h] [rbp-F0h] BYREF</span><br>  __int128 v19; <span class="hljs-comment">// [rsp+188h] [rbp-70h]</span><br>  __int128 v20; <span class="hljs-comment">// [rsp+198h] [rbp-60h]</span><br>  __int128 v21[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [rsp+1A8h] [rbp-50h] BYREF</span><br>  <span class="hljs-type">int</span> *v22; <span class="hljs-comment">// [rsp+1D0h] [rbp-28h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v23; <span class="hljs-comment">// [rsp+1D8h] [rbp-20h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v24; <span class="hljs-comment">// [rsp+1E8h] [rbp-10h]</span><br><br>  v24 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v23 = a5;<br>  v22 = a4;<br>  sub_2DA0();<br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( v5 != v24 )<br>  &#123;<br>    sub_2D40(qword_1C928, <span class="hljs-number">0x190</span>LL);<br>    v23 = a1;<br>    v22 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>    <span class="hljs-built_in">memset</span>(v21, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v21));<br>    v20 = <span class="hljs-number">0LL</span>;<br>    v19 = <span class="hljs-number">0LL</span>;<br>    <span class="hljs-built_in">memset</span>(v18, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v18));<br>    v17 = <span class="hljs-number">0LL</span>;<br>    sub_2D20(v18 + <span class="hljs-number">4</span>, <span class="hljs-string">&quot;*.so&quot;</span>, <span class="hljs-number">0x80</span>LL, <span class="hljs-number">0xBC</span>LL, <span class="hljs-number">5LL</span>);<br>    v16[<span class="hljs-number">0</span>] = &amp;qword_234D0;<br>    v16[<span class="hljs-number">1</span>] = <span class="hljs-number">0xAC3FD</span>LL;<br>    LODWORD(v18[<span class="hljs-number">0</span>]) = <span class="hljs-number">1</span>;<br>    *&amp;v20 = off_233B8;<br>    *(&amp;v19 + <span class="hljs-number">1</span>) = &amp;qword_CFD40;<br>    DWORD2(v21[<span class="hljs-number">1</span>]) = <span class="hljs-number">1</span>;<br>    *(&amp;v20 + <span class="hljs-number">1</span>) = <span class="hljs-number">0x400000002</span>LL;<br>    LODWORD(v21[<span class="hljs-number">0</span>]) = <span class="hljs-number">5</span>;<br>    *(v21 + <span class="hljs-number">8</span>) = <span class="hljs-number">0LL</span>;<br>    sub_7330(v15);<br>    v15[<span class="hljs-number">0</span>] = qword_22CA8 + <span class="hljs-number">16</span>;<br>    v6 = &amp;qword_CF8D0;<br>    <span class="hljs-keyword">if</span> ( sub_7770(v15, &amp;qword_CF8D0, <span class="hljs-number">1062LL</span>) )<br>    &#123;<br>      v6 = v15;<br>      v7 = sub_5C10(v16, v15);<br>      <span class="hljs-keyword">if</span> ( *(&amp;v21[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>) )<br>        (sub_2EE0)();<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v7 = <span class="hljs-number">0LL</span>;<br>    &#125;<br>    v8 = v15;<br>    sub_7580(v15);<br>    <span class="hljs-keyword">if</span> ( __readfsqword(<span class="hljs-number">0x28</span>u) == v22 )<br>    &#123;<br>      LOBYTE(v5) = v7;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      sub_2D40(v15, v6);<br>      v14 = v7;<br>      v13 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>      <span class="hljs-keyword">if</span> ( v15 )<br>      &#123;<br>        <span class="hljs-built_in">strcpy</span>(v12, <span class="hljs-string">&quot;makekey&quot;</span>);<br>        v6 = v12;<br>        v9 = sub_5D40(v15, v12);<br>        <span class="hljs-keyword">if</span> ( v9 )<br>        &#123;<br>          v10 = v9;<br>          v8 = (v9 &amp; <span class="hljs-number">0xFFFFFFFFFFFFF000</span>LL);<br>          v6 = (<span class="hljs-string">&quot;pthread_create&quot;</span> + <span class="hljs-number">3</span>);<br>          sub_2E50(v9 &amp; <span class="hljs-number">0xFFFFFFFFFFFFF000</span>LL, <span class="hljs-number">4096LL</span>, <span class="hljs-number">3LL</span>);<br>          *v10 = qword_22CC0;<br>        &#125;<br>      &#125;<br>      v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>      <span class="hljs-keyword">if</span> ( v5 != v13 )<br>      &#123;<br>        sub_2D40(v8, v6);<br>        LOBYTE(v5) = <span class="hljs-number">1</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v5;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715220849.png" alt="image"></p>
<p>查看sub_50E0</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250715220917.png" alt="image"></p>
<p>发现了一些用于加载动态链接相关的字符串，结合之前创建线程，这个时候就猜测，应该已经在加载另外的so了</p>
<p>‍</p>
<p>安卓系统中，完成linker之后，dlopen去加载这个so，我们之前hook的是<code>android_dlopen_ext</code>，这里再去hook一下dlopen看看它加载了哪些so文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libdl.so&quot;</span>, <span class="hljs-string">&quot;android_dlopen_ext&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-comment">// console.log(&#x27;Entering &#x27; + functionName);</span><br>            <span class="hljs-comment">// Modify or log arguments if needed</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;load -&gt; &quot;</span>, args[<span class="hljs-number">0</span>].<span class="hljs-title function_">readCString</span>());<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>            <span class="hljs-comment">// console.log(&#x27;Leaving &#x27; + functionName);</span><br>            <span class="hljs-comment">// Modify or log return value if needed</span><br>        &#125;<br>    &#125;);<br><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook2</span>(<span class="hljs-params"></span>) &#123;<br>    <br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libdl.so&quot;</span>, <span class="hljs-string">&quot;dlopen&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-comment">// console.log(&#x27;Entering &#x27; + functionName);</span><br>            <span class="hljs-comment">// Modify or log arguments if needed</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&quot;dlopen load -&gt; &quot;</span>, args[<span class="hljs-number">0</span>].<span class="hljs-title function_">readCString</span>());<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>            <span class="hljs-comment">// console.log(&#x27;Leaving &#x27; + functionName);</span><br>            <span class="hljs-comment">// Modify or log return value if needed</span><br>        &#125;<br>    &#125;);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">hook</span>();<br>        <span class="hljs-title function_">hook2</span>();<br>    &#125;)<br>&#125;<br><br><span class="hljs-comment">// setTimeout(main, 1000);</span><br><span class="hljs-title function_">setImmediate</span>(main);<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716105833.png" alt="image"></p>
<p>看到这里，基本上可以说明就是自定义linker加固so文件了</p>
<p>‍</p>
<p>查阅资料发现，自定义linker加固so的流程是，自定义文件格式加密so，然后壳代码实现将加密的so文件加载，链接重定位并修正soinfo（三部曲）</p>
<p>简单来说就是将elf文件的.text等数据段进行加密，然后在link的时候补充soinfo</p>
<blockquote>
<p><code>soinfo</code> 是 <strong>Android linker</strong> 内部维护的数据结构，用于 <strong>管理已加载的共享库（.so）</strong> 。每个被 <code>dlopen</code> 或程序依赖的 <code>.so</code> 都会有一个对应的 <code>soinfo</code> 结构，存储：</p>
<ul>
<li><strong>库的基地址（加载地址）</strong></li>
<li><strong>符号表、重定位表、依赖关系</strong></li>
<li><strong>动态段（</strong>​ <strong>​<code>.dynamic</code>​</strong>​ <strong>）解析后的信息</strong></li>
<li><strong>命名空间（用于库隔离）</strong></li>
<li><h3 id="​soinfo​-的生命周期"><a href="#​soinfo​-的生命周期" class="headerlink" title="​soinfo​ 的生命周期"></a><strong>​<code>soinfo</code>​</strong> <strong>的生命周期</strong></h3><ol>
<li><strong>加载阶段</strong>：<code>dlopen</code> → <code>linker</code> 解析 ELF → 创建 <code>soinfo</code> 并填充信息。</li>
<li><strong>链接阶段</strong>：<code>linker</code> 根据 <code>.dynamic</code> 段解析依赖、符号、重定位。</li>
<li><strong>运行时</strong>：<code>dlsym</code> 通过 <code>soinfo</code> 查找符号地址。</li>
<li><strong>卸载阶段</strong>：<code>dlclose</code> 释放 <code>soinfo</code>。</li>
</ol>
</li>
</ul>
</blockquote>
<p>由于之前的so在执行的时候link了另外的so，所以将其放入010editor里查找elf头</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716112140.png" alt="image"></p>
<p>找到了elf头，并且可以看到program header已经被加密了</p>
<p>写一个脚本，将0xd0000之后的内容提取出来</p>
<p>提取出来的so文件ida是打不开的，因为program header已经被加密了</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716113145.png" alt="image"></p>
<p>此时就需要找到这个so是在哪里被解密的</p>
<p>用oacia大佬的项目来分析一下程序执行流</p>
<p><a target="_blank" rel="noopener" href="https://github.com/oacia/stalker_trace_so">https://github.com/oacia/stalker_trace_so</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716114648.png" alt="image"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs js">[<span class="hljs-title class_">Android</span> <span class="hljs-title class_">Emulator</span> <span class="hljs-number">5554</span>::com.<span class="hljs-property">example</span>.<span class="hljs-property">nativetest</span> ]-&gt; start <span class="hljs-title class_">Stalker</span>!<br><span class="hljs-title class_">Stalker</span> end!<br><span class="hljs-attr">call1</span>:JNI_OnLoad<br><span class="hljs-attr">call2</span>:sub_C840<br><span class="hljs-attr">call3</span>:ffi_call<br><span class="hljs-attr">call4</span>:sub_C450<br><span class="hljs-attr">call5</span>:sub_7330<br><span class="hljs-attr">call6</span>:sub_7770<br><span class="hljs-attr">call7</span>:sub_7370<br><span class="hljs-attr">call8</span>:_ZN9__arm_c_19__arm_c_0Ev<br><span class="hljs-attr">call9</span>:sub_77B0<br><span class="hljs-attr">call10</span>:sub_71F0<br><span class="hljs-attr">call11</span>:sub_C560<br><span class="hljs-attr">call12</span>:sub_7240<br><span class="hljs-attr">call13</span>:sub_42C0<br><span class="hljs-attr">call14</span>:sub_6310<br><span class="hljs-attr">call15</span>:sub_6A30<br><span class="hljs-attr">call16</span>:sub_6760<br><span class="hljs-attr">call17</span>:sub_4B40<br><span class="hljs-attr">call18</span>:sub_4F70<br><span class="hljs-attr">call19</span>:sub_50E0<br><span class="hljs-attr">call20</span>:sub_3B20<br><span class="hljs-attr">call21</span>:sub_7000<br><span class="hljs-attr">call22</span>:sub_6350<br><span class="hljs-attr">call23</span>:sub_7580<br><span class="hljs-attr">call24</span>:sub_10E1D0<br><span class="hljs-attr">call25</span>:sub_1BC3C0<br><span class="hljs-attr">call26</span>:sub_10B270<br><span class="hljs-attr">call27</span>:sub_1465C0<br><span class="hljs-attr">call28</span>:sub_14AC90<br><span class="hljs-attr">call29</span>:sub_10A5C0<br><span class="hljs-attr">call30</span>:sub_1BDD20<br><span class="hljs-attr">call31</span>:sub_14B3E0<br><span class="hljs-attr">call32</span>:sub_14D100<br><span class="hljs-attr">call33</span>:sub_1BDD50<br><span class="hljs-attr">call34</span>:sub_1A9BD0<br><span class="hljs-attr">call35</span>:sub_1459B0<br><span class="hljs-attr">call36</span>:sub_1BD700<br><span class="hljs-attr">call37</span>:sub_1BD790<br><span class="hljs-attr">call38</span>:sub_10ED90<br><span class="hljs-attr">call39</span>:sub_1120F0<br><span class="hljs-attr">call40</span>:sub_10CC10<br><span class="hljs-attr">call41</span>:sub_106F90<br><span class="hljs-attr">call42</span>:sub_1BB530<br><span class="hljs-attr">call43</span>:sub_1BB620<br><span class="hljs-attr">call44</span>:sub_1BC4E0<br><span class="hljs-attr">call45</span>:sub_1BB980<br><span class="hljs-attr">call46</span>:sub_1BBC00<br><span class="hljs-attr">call47</span>:sub_1BBE10<br><span class="hljs-attr">call48</span>:sub_1BC1D0<br><span class="hljs-attr">call49</span>:sub_1BC4B0<br><span class="hljs-attr">call55</span>:sub_1BDF10<br><span class="hljs-attr">call56</span>:sub_116720<br><span class="hljs-attr">call57</span>:sub_1BDD00<br><span class="hljs-attr">call58</span>:sub_1AD9E0<br><span class="hljs-attr">call59</span>:sub_1ADB60<br><span class="hljs-attr">call60</span>:sub_1C49A0<br><span class="hljs-attr">call61</span>:sub_1CAD30<br><span class="hljs-attr">call62</span>:sub_1C8EC0<br><span class="hljs-attr">call63</span>:sub_16FA70<br></code></pre></td></tr></table></figure>

<p>再看一下fix之后的文件的控制流</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716200634.png" alt="image"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs js">[<span class="hljs-title class_">Android</span> <span class="hljs-title class_">Emulator</span> <span class="hljs-number">5554</span>::com.<span class="hljs-property">example</span>.<span class="hljs-property">nativetest</span> ]-&gt; start <span class="hljs-title class_">Stalker</span>!<br><span class="hljs-attr">call1</span>:JNI_OnLoad<br><span class="hljs-attr">call2</span>:sub_C840<br><span class="hljs-attr">call3</span>:ffi_call<br><span class="hljs-attr">call4</span>:sub_C450<br><span class="hljs-attr">call5</span>:sub_7330<br><span class="hljs-attr">call6</span>:sub_7770<br><span class="hljs-attr">call7</span>:sub_7370<br><span class="hljs-attr">call8</span>:_ZN9__arm_c_19__arm_c_0Ev<br><span class="hljs-attr">call9</span>:sub_77B0<br><span class="hljs-attr">call10</span>:sub_71F0<br><span class="hljs-attr">call11</span>:sub_C560<br><span class="hljs-attr">call12</span>:sub_7240<br><span class="hljs-attr">call13</span>:sub_42C0<br><span class="hljs-attr">call14</span>:sub_6310<br><span class="hljs-attr">call15</span>:sub_6A30<br><span class="hljs-attr">call16</span>:sub_6760<br><span class="hljs-attr">call17</span>:sub_4B40<br><span class="hljs-attr">call18</span>:sub_4F70<br><span class="hljs-attr">call19</span>:sub_50E0<br><span class="hljs-attr">call20</span>:sub_3B20<br><span class="hljs-attr">call21</span>:sub_7000<br><span class="hljs-attr">call22</span>:sub_6350<br><span class="hljs-attr">call23</span>:sub_7580<br><span class="hljs-attr">call24</span>:sub_10E1D0<br><span class="hljs-attr">call25</span>:sub_1BC3C0<br><span class="hljs-attr">call26</span>:sub_10B270<br><span class="hljs-attr">call27</span>:sub_1465C0<br><span class="hljs-attr">call28</span>:sub_14AC90<br><span class="hljs-attr">call29</span>:sub_10A5C0<br><span class="hljs-attr">call30</span>:sub_1BDD20<br><span class="hljs-attr">call31</span>:sub_14B3E0<br><span class="hljs-attr">call32</span>:sub_14D100<br><span class="hljs-attr">call33</span>:sub_1BDD50<br><span class="hljs-attr">call34</span>:sub_1A9BD0<br><span class="hljs-attr">call35</span>:sub_1459B0<br><span class="hljs-attr">call36</span>:sub_1BD700<br><span class="hljs-attr">call37</span>:sub_1BD790<br><span class="hljs-attr">call38</span>:sub_10ED90<br><span class="hljs-attr">call39</span>:sub_1120F0<br><span class="hljs-attr">call40</span>:sub_10CC10<br><span class="hljs-attr">call41</span>:sub_106F90<br><span class="hljs-attr">call42</span>:sub_1BB530<br><span class="hljs-attr">call43</span>:sub_1BB620<br><span class="hljs-attr">call44</span>:sub_1BC4E0<br><span class="hljs-attr">call45</span>:sub_1BB980<br><span class="hljs-attr">call46</span>:sub_1BBC00<br><span class="hljs-attr">call47</span>:sub_1BBE10<br><span class="hljs-attr">call48</span>:sub_1BC1D0<br><span class="hljs-attr">call49</span>:sub_1BC4B0<br><span class="hljs-attr">call50</span>:sub_14B000<br><span class="hljs-attr">call51</span>:sub_14D310<br><span class="hljs-attr">call52</span>:_Z9__arm_a_2PcmS_Rii<br><span class="hljs-attr">call53</span>:sub_14ACC0<br><span class="hljs-attr">call54</span>:sub_10C5F0<br><span class="hljs-attr">call55</span>:sub_1BDF10<br><span class="hljs-attr">call56</span>:sub_116720<br><span class="hljs-attr">call57</span>:sub_1BDD00<br><span class="hljs-attr">call58</span>:sub_1AD9E0<br><span class="hljs-attr">call59</span>:sub_1ADB60<br><span class="hljs-attr">call60</span>:sub_1C49A0<br><span class="hljs-attr">call61</span>:sub_1CAD30<br><span class="hljs-attr">call62</span>:sub_1C8EC0<br><span class="hljs-attr">call63</span>:sub_16FA70<br></code></pre></td></tr></table></figure>

<p>‍</p>
<p>‍</p>
<p>知道了控制流之后，虽然是自定义linker加固so，但是最后肯定还是需要dlopen去加载so的，在IDA里交叉引用一下dlopen，看看在哪里被调用了</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716115942.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716120042.png" alt="image"></p>
<p>只有一处调用，全是switch case结构</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716120058.png" alt="image"></p>
<p>查看Android源码linker的预链接部分，同样也是大量的switch case结构</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716160821.png" alt="image"></p>
<p>此时就可以在IDA中导入soinfo结构体了（结构体代码来自SWDD）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//IMPORTANT</span><br><span class="hljs-comment">//ELF64 启用该宏</span><br>#define __LP64__  <span class="hljs-number">1</span><br><span class="hljs-comment">//ELF32 启用该宏</span><br><span class="hljs-comment">//#define __work_around_b_24465209__  1</span><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment">//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp</span><br><span class="hljs-comment">架构为 32 位 定义__work_around_b_24465209__宏</span><br><span class="hljs-comment">arch: &#123;</span><br><span class="hljs-comment">        arm: &#123;cflags: [&quot;-D__work_around_b_24465209__&quot;],&#125;,</span><br><span class="hljs-comment">        x86: &#123;cflags: [&quot;-D__work_around_b_24465209__&quot;],&#125;,</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">*/</span><br> <br><span class="hljs-comment">//android-platform\bionic\libc\include\link.h</span><br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(__LP64__)<br>#define <span class="hljs-title class_">ElfW</span>(type) <span class="hljs-title class_">Elf64</span>_ ## type<br>#<span class="hljs-keyword">else</span><br>#define <span class="hljs-title class_">ElfW</span>(type) <span class="hljs-title class_">Elf32</span>_ ## type<br>#endif<br> <br><span class="hljs-comment">//android-platform\bionic\linker\linker_common_types.h</span><br><span class="hljs-comment">// Android uses RELA for LP64.</span><br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(__LP64__)<br>#define <span class="hljs-variable constant_">USE_RELA</span> <span class="hljs-number">1</span><br>#endif<br> <br><span class="hljs-comment">//android-platform\bionic\libc\kernel\uapi\asm-generic\int-ll64.h</span><br><span class="hljs-comment">//__signed__--&gt;signed</span><br>typedef signed char __s8;<br>typedef unsigned char __u8;<br>typedef signed short __s16;<br>typedef unsigned short __u16;<br>typedef signed int __s32;<br>typedef unsigned int __u32;<br>typedef signed long long __s64;<br>typedef unsigned long long __u64;<br> <br><span class="hljs-comment">//A12-src\msm-google\include\uapi\linux\elf.h</span><br><span class="hljs-comment">/* 32-bit ELF base types. */</span><br>typedef __u32   <span class="hljs-title class_">Elf32</span>_Addr;<br>typedef __u16   <span class="hljs-title class_">Elf32</span>_Half;<br>typedef __u32   <span class="hljs-title class_">Elf32</span>_Off;<br>typedef __s32   <span class="hljs-title class_">Elf32</span>_Sword;<br>typedef __u32   <span class="hljs-title class_">Elf32</span>_Word;<br> <br><span class="hljs-comment">/* 64-bit ELF base types. */</span><br>typedef __u64   <span class="hljs-title class_">Elf64</span>_Addr;<br>typedef __u16   <span class="hljs-title class_">Elf64</span>_Half;<br>typedef __s16   <span class="hljs-title class_">Elf64</span>_SHalf;<br>typedef __u64   <span class="hljs-title class_">Elf64</span>_Off;<br>typedef __s32   <span class="hljs-title class_">Elf64</span>_Sword;<br>typedef __u32   <span class="hljs-title class_">Elf64</span>_Word;<br>typedef __u64   <span class="hljs-title class_">Elf64</span>_Xword;<br>typedef __s64   <span class="hljs-title class_">Elf64</span>_Sxword;<br> <br>typedef struct dynamic&#123;<br>  <span class="hljs-title class_">Elf32</span>_Sword d_tag;<br>  union&#123;<br>    <span class="hljs-title class_">Elf32</span>_Sword d_val;<br>    <span class="hljs-title class_">Elf32</span>_Addr  d_ptr;<br>  &#125; d_un;<br>&#125; <span class="hljs-title class_">Elf32</span>_Dyn;<br> <br>typedef struct &#123;<br>  <span class="hljs-title class_">Elf64</span>_Sxword d_tag;       <span class="hljs-comment">/* entry tag value */</span><br>  union &#123;<br>    <span class="hljs-title class_">Elf64</span>_Xword d_val;<br>    <span class="hljs-title class_">Elf64</span>_Addr d_ptr;<br>  &#125; d_un;<br>&#125; <span class="hljs-title class_">Elf64</span>_Dyn;<br> <br>typedef struct elf32_rel &#123;<br>  <span class="hljs-title class_">Elf32</span>_Addr    r_offset;<br>  <span class="hljs-title class_">Elf32</span>_Word    r_info;<br>&#125; <span class="hljs-title class_">Elf32</span>_Rel;<br> <br>typedef struct elf64_rel &#123;<br>  <span class="hljs-title class_">Elf64</span>_Addr r_offset;  <span class="hljs-comment">/* Location at which to apply the action */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword r_info;   <span class="hljs-comment">/* index and type of relocation */</span><br>&#125; <span class="hljs-title class_">Elf64</span>_Rel;<br> <br>typedef struct elf32_rela&#123;<br>  <span class="hljs-title class_">Elf32</span>_Addr    r_offset;<br>  <span class="hljs-title class_">Elf32</span>_Word    r_info;<br>  <span class="hljs-title class_">Elf32</span>_Sword   r_addend;<br>&#125; <span class="hljs-title class_">Elf32</span>_Rela;<br> <br>typedef struct elf64_rela &#123;<br>  <span class="hljs-title class_">Elf64</span>_Addr r_offset;  <span class="hljs-comment">/* Location at which to apply the action */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword r_info;   <span class="hljs-comment">/* index and type of relocation */</span><br>  <span class="hljs-title class_">Elf64</span>_Sxword r_addend;    <span class="hljs-comment">/* Constant addend used to compute value */</span><br>&#125; <span class="hljs-title class_">Elf64</span>_Rela;<br> <br>typedef struct elf32_sym&#123;<br>  <span class="hljs-title class_">Elf32</span>_Word    st_name;<br>  <span class="hljs-title class_">Elf32</span>_Addr    st_value;<br>  <span class="hljs-title class_">Elf32</span>_Word    st_size;<br>  unsigned char st_info;<br>  unsigned char st_other;<br>  <span class="hljs-title class_">Elf32</span>_Half    st_shndx;<br>&#125; <span class="hljs-title class_">Elf32</span>_Sym;<br> <br>typedef struct elf64_sym &#123;<br>  <span class="hljs-title class_">Elf64</span>_Word st_name;       <span class="hljs-comment">/* Symbol name, index in string tbl */</span><br>  unsigned char st_info;    <span class="hljs-comment">/* Type and binding attributes */</span><br>  unsigned char st_other;   <span class="hljs-comment">/* No defined meaning, 0 */</span><br>  <span class="hljs-title class_">Elf64</span>_Half st_shndx;      <span class="hljs-comment">/* Associated section index */</span><br>  <span class="hljs-title class_">Elf64</span>_Addr st_value;      <span class="hljs-comment">/* Value of the symbol */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword st_size;      <span class="hljs-comment">/* Associated symbol size */</span><br>&#125; <span class="hljs-title class_">Elf64</span>_Sym;<br> <br>#define <span class="hljs-variable constant_">EI_NIDENT</span>   <span class="hljs-number">16</span><br> <br>typedef struct elf32_hdr&#123;<br>  unsigned char e_ident[<span class="hljs-variable constant_">EI_NIDENT</span>];<br>  <span class="hljs-title class_">Elf32</span>_Half    e_type;<br>  <span class="hljs-title class_">Elf32</span>_Half    e_machine;<br>  <span class="hljs-title class_">Elf32</span>_Word    e_version;<br>  <span class="hljs-title class_">Elf32</span>_Addr    e_entry;  <span class="hljs-comment">/* Entry point */</span><br>  <span class="hljs-title class_">Elf32</span>_Off e_phoff;<br>  <span class="hljs-title class_">Elf32</span>_Off e_shoff;<br>  <span class="hljs-title class_">Elf32</span>_Word    e_flags;<br>  <span class="hljs-title class_">Elf32</span>_Half    e_ehsize;<br>  <span class="hljs-title class_">Elf32</span>_Half    e_phentsize;<br>  <span class="hljs-title class_">Elf32</span>_Half    e_phnum;<br>  <span class="hljs-title class_">Elf32</span>_Half    e_shentsize;<br>  <span class="hljs-title class_">Elf32</span>_Half    e_shnum;<br>  <span class="hljs-title class_">Elf32</span>_Half    e_shstrndx;<br>&#125; <span class="hljs-title class_">Elf32</span>_Ehdr;<br> <br>typedef struct elf64_hdr &#123;<br>  unsigned char e_ident[<span class="hljs-variable constant_">EI_NIDENT</span>]; <span class="hljs-comment">/* ELF &quot;magic number&quot; */</span><br>  <span class="hljs-title class_">Elf64</span>_Half e_type;<br>  <span class="hljs-title class_">Elf64</span>_Half e_machine;<br>  <span class="hljs-title class_">Elf64</span>_Word e_version;<br>  <span class="hljs-title class_">Elf64</span>_Addr e_entry;       <span class="hljs-comment">/* Entry point virtual address */</span><br>  <span class="hljs-title class_">Elf64</span>_Off e_phoff;        <span class="hljs-comment">/* Program header table file offset */</span><br>  <span class="hljs-title class_">Elf64</span>_Off e_shoff;        <span class="hljs-comment">/* Section header table file offset */</span><br>  <span class="hljs-title class_">Elf64</span>_Word e_flags;<br>  <span class="hljs-title class_">Elf64</span>_Half e_ehsize;<br>  <span class="hljs-title class_">Elf64</span>_Half e_phentsize;<br>  <span class="hljs-title class_">Elf64</span>_Half e_phnum;<br>  <span class="hljs-title class_">Elf64</span>_Half e_shentsize;<br>  <span class="hljs-title class_">Elf64</span>_Half e_shnum;<br>  <span class="hljs-title class_">Elf64</span>_Half e_shstrndx;<br>&#125; <span class="hljs-title class_">Elf64</span>_Ehdr;<br> <br><span class="hljs-comment">/* These constants define the permissions on sections in the program</span><br><span class="hljs-comment">   header, p_flags. */</span><br>#define <span class="hljs-variable constant_">PF_R</span>        <span class="hljs-number">0x4</span><br>#define <span class="hljs-variable constant_">PF_W</span>        <span class="hljs-number">0x2</span><br>#define <span class="hljs-variable constant_">PF_X</span>        <span class="hljs-number">0x1</span><br> <br>typedef struct elf32_phdr&#123;<br>  <span class="hljs-title class_">Elf32</span>_Word    p_type;<br>  <span class="hljs-title class_">Elf32</span>_Off p_offset;<br>  <span class="hljs-title class_">Elf32</span>_Addr    p_vaddr;<br>  <span class="hljs-title class_">Elf32</span>_Addr    p_paddr;<br>  <span class="hljs-title class_">Elf32</span>_Word    p_filesz;<br>  <span class="hljs-title class_">Elf32</span>_Word    p_memsz;<br>  <span class="hljs-title class_">Elf32</span>_Word    p_flags;<br>  <span class="hljs-title class_">Elf32</span>_Word    p_align;<br>&#125; <span class="hljs-title class_">Elf32</span>_Phdr;<br> <br>typedef struct elf64_phdr &#123;<br>  <span class="hljs-title class_">Elf64</span>_Word p_type;<br>  <span class="hljs-title class_">Elf64</span>_Word p_flags;<br>  <span class="hljs-title class_">Elf64</span>_Off p_offset;       <span class="hljs-comment">/* Segment file offset */</span><br>  <span class="hljs-title class_">Elf64</span>_Addr p_vaddr;       <span class="hljs-comment">/* Segment virtual address */</span><br>  <span class="hljs-title class_">Elf64</span>_Addr p_paddr;       <span class="hljs-comment">/* Segment physical address */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword p_filesz;     <span class="hljs-comment">/* Segment size in file */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword p_memsz;      <span class="hljs-comment">/* Segment size in memory */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword p_align;      <span class="hljs-comment">/* Segment alignment, file &amp; memory */</span><br>&#125; <span class="hljs-title class_">Elf64</span>_Phdr;<br> <br>typedef struct elf32_shdr &#123;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_name;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_type;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_flags;<br>  <span class="hljs-title class_">Elf32</span>_Addr    sh_addr;<br>  <span class="hljs-title class_">Elf32</span>_Off sh_offset;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_size;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_link;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_info;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_addralign;<br>  <span class="hljs-title class_">Elf32</span>_Word    sh_entsize;<br>&#125; <span class="hljs-title class_">Elf32</span>_Shdr;<br> <br>typedef struct elf64_shdr &#123;<br>  <span class="hljs-title class_">Elf64</span>_Word sh_name;       <span class="hljs-comment">/* Section name, index in string tbl */</span><br>  <span class="hljs-title class_">Elf64</span>_Word sh_type;       <span class="hljs-comment">/* Type of section */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword sh_flags;     <span class="hljs-comment">/* Miscellaneous section attributes */</span><br>  <span class="hljs-title class_">Elf64</span>_Addr sh_addr;       <span class="hljs-comment">/* Section virtual addr at execution */</span><br>  <span class="hljs-title class_">Elf64</span>_Off sh_offset;      <span class="hljs-comment">/* Section file offset */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword sh_size;      <span class="hljs-comment">/* Size of section in bytes */</span><br>  <span class="hljs-title class_">Elf64</span>_Word sh_link;       <span class="hljs-comment">/* Index of another section */</span><br>  <span class="hljs-title class_">Elf64</span>_Word sh_info;       <span class="hljs-comment">/* Additional section information */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword sh_addralign; <span class="hljs-comment">/* Section alignment */</span><br>  <span class="hljs-title class_">Elf64</span>_Xword sh_entsize;   <span class="hljs-comment">/* Entry size if section holds table */</span><br>&#125; <span class="hljs-title class_">Elf64</span>_Shdr;<br> <br><span class="hljs-comment">//android-platform\bionic\linker\linker_soinfo.h</span><br>typedef <span class="hljs-title function_">void</span> (*linker_dtor_function_t)();<br>typedef <span class="hljs-title function_">void</span> (*linker_ctor_function_t)(int, char**, char**);<br> <br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(__work_around_b_24465209__)<br>#define <span class="hljs-variable constant_">SOINFO_NAME_LEN</span> <span class="hljs-number">128</span><br>#endif<br> <br>struct soinfo &#123;<br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(__work_around_b_24465209__)<br>  char old_name_[<span class="hljs-variable constant_">SOINFO_NAME_LEN</span>];<br>#endif<br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Phdr</span>)* phdr;<br>  size_t phnum;<br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(__work_around_b_24465209__)<br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Addr</span>) unused0; <span class="hljs-comment">// DO NOT USE, maintained for compatibility.</span><br>#endif<br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Addr</span>) base;<br>  size_t size;<br> <br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(__work_around_b_24465209__)<br>  uint32_t unused1;  <span class="hljs-comment">// DO NOT USE, maintained for compatibility.</span><br>#endif<br> <br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Dyn</span>)* dynamic;<br> <br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(__work_around_b_24465209__)<br>  uint32_t unused2; <span class="hljs-comment">// DO NOT USE, maintained for compatibility</span><br>  uint32_t unused3; <span class="hljs-comment">// DO NOT USE, maintained for compatibility</span><br>#endif<br> <br>  soinfo* next;<br>  uint32_t flags_;<br> <br>  <span class="hljs-keyword">const</span> char* strtab_;<br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Sym</span>)* symtab_;<br> <br>  size_t nbucket_;<br>  size_t nchain_;<br>  uint32_t* bucket_;<br>  uint32_t* chain_;<br> <br>#<span class="hljs-keyword">if</span> !<span class="hljs-title function_">defined</span>(__LP64__)<br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Addr</span>)** unused4; <span class="hljs-comment">// DO NOT USE, maintained for compatibility</span><br>#endif<br> <br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span>(<span class="hljs-variable constant_">USE_RELA</span>)<br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Rela</span>)* plt_rela_;<br>  size_t plt_rela_count_;<br> <br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Rela</span>)* rela_;<br>  size_t rela_count_;<br>#<span class="hljs-keyword">else</span><br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Rel</span>)* plt_rel_;<br>  size_t plt_rel_count_;<br> <br>  <span class="hljs-title class_">ElfW</span>(<span class="hljs-title class_">Rel</span>)* rel_;<br>  size_t rel_count_;<br>#endif<br> <br>  linker_ctor_function_t* preinit_array_;<br>  size_t preinit_array_count_;<br> <br>  linker_ctor_function_t* init_array_;<br>  size_t init_array_count_;<br>  linker_dtor_function_t* fini_array_;<br>  size_t fini_array_count_;<br> <br>  linker_ctor_function_t init_func_;<br>  linker_dtor_function_t fini_func_;<br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment">#if defined (__arm__)</span><br><span class="hljs-comment">  // ARM EABI section used for stack unwinding.</span><br><span class="hljs-comment">  uint32_t* ARM_exidx;</span><br><span class="hljs-comment">  size_t ARM_exidx_count;</span><br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">  size_t ref_count_;</span><br><span class="hljs-comment">// 怎么找不 link_map 这个类型的声明...</span><br><span class="hljs-comment">  link_map link_map_head;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">  bool constructors_called;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">  // When you read a virtual address from the ELF file, add this</span><br><span class="hljs-comment">  //value to get the corresponding address in the process&#x27; address space.</span><br><span class="hljs-comment">  ElfW (Addr) load_bias;</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">#if !defined (__LP64__)</span><br><span class="hljs-comment">  bool has_text_relocations;</span><br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">  bool has_DT_SYMBOLIC;</span><br><span class="hljs-comment">*/</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716161049.png" alt="image"></p>
<p>按Y将该函数类型改成so</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716161551.png" alt="image"></p>
<p>好看多了，但看着还是有点奇怪，可能这个soinfo被魔改过了</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716161625.png" alt="image"></p>
<p>交叉引用一下，来到上一个函数，有这样一个函数，我们点进去看看</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716161856.png" alt="image"></p>
<p>最终来到这个地方</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716162052.png" alt="image"></p>
<p>有一个很可疑的点是v5往上加了0x38</p>


<p>在ELF文件中，32 位 ELF 文件程序头大小是 0x20（32 字节），64 位 ELF 文件程序头大小是 0x38（56 字节）</p>
<p>这里正好就是0x38，所以这里可能就在加载程序头了。</p>
<p>既然要加载程序头，那么在加载之前肯定需要解密，往上引用一下，最后又来到这里，有点眼熟</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716163100.png" alt="image"></p>
<p>还记得之前拿到的执行流么，从7000，即加载程序头的函数开始，往上找一找</p>
<p>在50E0的位置发现这里加载了一些东西</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716201757.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716201838.png" alt="image"></p>
<p>继续往上翻，在7240的位置填入了一个地址进去</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716210205.png" alt="image"></p>
<p>去那个地址看一眼，AUV，这不rc4么</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716210241.png" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716210231.png" alt="image"></p>
<p>上面那个则是初始化算法</p>
<p><img src="https://cdn.jsdelivr.net/gh/F10ower/img@main/img/20250716210313.png" alt="image"></p>
<p>直接hook出sbox</p>
<p>‍</p>
</p></div><div class="post-footer"><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: Yourname</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2025-07-25</span><a class="tag" href="/categories/逆向/" title="逆向">逆向 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/移动安全/" title="移动安全">移动安全 </a><span class="leancloud_visitors"></span><span>About5419words, 18min3secread</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=Share%0A%0A%E4%B8%B4%E6%B1%9F%E4%BB%99%E7%9A%84%E8%8A%B1%E9%97%B4%E9%98%81%20%C2%B7%20360%E5%8A%A0%E5%9B%BA%E4%BF%9D%E5%85%8D%E8%B4%B9%E7%89%88%E5%88%86%E6%9E%90%0Ahttp://f10ower.github.io/2025/07/25/360%E5%8A%A0%E5%9B%BA%E4%BF%9D%E5%85%8D%E8%B4%B9%E7%89%88/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2025/10/15/Native%E5%87%BD%E6%95%B0%E6%B3%A8%E5%86%8C/" title="安卓Native层函数注册">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/07/26/%E6%8A%A5%E4%BB%BB%E5%AE%89%E4%B9%A6/" title="报任安书">Próximo post</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>